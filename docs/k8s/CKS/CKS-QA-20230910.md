

<img align=left height='36pix' src='https://img.shields.io/badge/Kubernetes-v1.27-326CE5?style=for-the-badge&logo=kubernetes&logoColor=F5F5F5'>



[TOC]

# <strong style='color: #00B9E4'>1. 准备工作</strong>

## 1.1 证书详情

> https://training.linuxfoundation.cn/certificates/16

## 1.2 考试说明

|  ID  |     ITEM     |     COMMENTS     |
| :--: | :----------: | :--------------: |
|  1   | Score Needed |    ==67==/100    |
|  2   |   集群*16    | 练习环境：集群*1 |
|  3   |     题序     |       乱序       |

## 1.3 准备环境

**[kiosk@k8s-master] $**

```bash
/yourpath/cks-setup
```



# <strong style='color: #00B9E4'>2. 练习题（考试时是乱序）</strong>

## Task 1. kube-bench-6%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>



**Context**

针对 <a>kubeadm</a> 创建的 cluster 运行 CIS 基准测试工具时，发现了多个必须立即解决的问题。

**Task**

通过配置修复所有问题并重新启动受影响的组件以确保新设置生效。

修复针对API服务器发现的所有以下违规行为：

<div style="background: #F9DBD8; display: table; width: 100%">
  <dl>
  <dt style='float: left; width: 10%; text-align: center;'>1.2.7</dt>
    <dt style='float: left; width: 80%;'>Ensure that the <a>--authorization-mode</a> argument is not set to <a>AlwaysAllow</a></dt>
    <dt style='float: left; width: 10%; text-align: center'>FAIL</dt></dl></div>
<div style="background: #F9DBD8; display: table; width: 100%"><dl><dt style='float: left; width: 10%; text-align: center'>1.2.8</dt>
    <dt style='float: left; width: 80%;'>Ensure that the <a>--authorization-mode</a> argument includes <a>Node</a></dt>
  <dt style='float: left; width: 10%; text-align: center'>FAIL</dt></dl></div>
<div style="background: #F9DBD8; display: table; width: 100%"><dl><dt style='float: left; width: 10%; text-align: center'>1.2.9</dt>
    <dt style='float: left; width: 80%; margin-bottom: 20px;'>Ensure that the <a>--authorization-mode</a> argument includes <a>RBAC</a></dt>
    <dt style='float: left; width: 10%; text-align: center'>FAIL</dt>
  </dl></div>

修复针对Kubelet发现的所有以下违规行为：

<div style="background: #F9DBD8; display: table; width: 100%">
  <dl>
  <dt style='float: left; width: 10%; text-align: center'>4.2.1</dt><dt style='float: left; width: 80%;'>Ensure that the <a>anonymous-auth</a> argument is set to <a>false</a></dt><dt style='float: left; width: 10%; text-align: center'>FAIL</dt></dl></div>
<div style="background: #F9DBD8; display: table; width: 100%;">
  <dl><dt style='float: left; width: 10%; text-align: center;'>4.2.2</dt><dt style='float: left; width: 80%; margin-bottom: 20px;'>Ensure that the <a>--authorization-mode</a> argument is not set to <a>AlwaysAllow</a></dt><dt style='float: left; width: 10%; text-align: center'>FAIL</dt>
  </dl></div>


<div style="background: #CFE2F0; padding: 12px; line-height: 24px; margin-bottom: 24px; ">
  尽可能使用 <a>Webhook</a> 身份验证/授权。
  </div>

修复针对 etcd 发现的所有以下违规行为：

<div style="background: #F9DBD8; display: table; width: 100%">
  <dl>
  <dt style='float: left; width: 10%; text-align: center; margin-bottom: 14px;'>2.2</dt><dt style='float: left; width: 80%;'>Ensure that the <a>--client-cert-auth</a> argument is set to <a>true</a></dt><dt style='float: left; width: 10%; text-align: center'>FAIL</dt>
  </dl></div>


<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;"><dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> kiosk@k8s-master:~$ <b>cks-setup 1</b>
</div>
<hr>


<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>
<hr>


<img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**


1. 切换 kubernetes 集群

```bash
*$ kubectl config use-context ck8s

*$ kubectl get nodes

*$ ssh root@k8s-master
```

2. 按题意要求修改 kube-apiserver.yaml

```bash
*# mkdir /root/exam
*# cp -rf /etc/kubernetes/manifests /root/exam/

*# vim /etc/kubernetes/manifests/kube-apiserver.yaml
```

```yaml
...此处省略...
#   - --authorization-mode=AlwaysAllow
    - --authorization-mode=Node,RBAC
...此处省略...
```

3. 按照题意要求，确认修改方法

```bash
# grep -r 4.2.1 /etc/kube-bench
# vim /etc/kube-bench/cfg/cis-1.5/node.yaml
/4.2.1
:q!

# grep -r 2.2 /etc/kube-bench/cfg/
/2.2
:q!
```

4. 选择一种方法修改，考试时只需要修改**[root@k8s-master]**，练习环境全改

```bash
# systemctl cat kubelet.service | grep \\-config
Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"

# cp /var/lib/kubelet/config.yaml /root/exam/

# vim /var/lib/kubelet/config.yaml
```

```yaml
apiVersion: kubelet.config.k8s.io/v1beta1
authentication:
  anonymous:
#   enabled: true
    enabled: false
...
authorization:
# mode: AlwaysAllow
  mode: Webhook
...此处省略...
```

```bash
# systemctl restart kubelet
```

4. 按题意要求修改 etcd.yaml

```bash
*$ kube-bench run -s etcd

*# vim /etc/kubernetes/manifests/etcd.yaml
```

```yaml
...此处省略...
#   - --client-cert-auth=false
    - --client-cert-auth=true
...此处省略...
```

5. 配置立即生效

```bash
# systemctl restart kubelet
```

6. 输出中无上述 id

```bash
$ kube-bench master

$ sudo kube-bench node

$ sudo kube-bench run -s etcd
```



## Task 2. Pod 指定 ServiceAccount-4%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>


> PS: 
>
> - `serviceaccount`
>
> [为 Pod 配置服务账号 | Kubernetes](https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-service-account/)



**Context**

您组织的安全策略包括：

- ServiceAccount 不得自动挂载 API 凭据
- ServiceAccount 名称必须以 "-sa" 结尾

清单文件 <a>/home/kiosk/KSCH00301/pod-manifest.yaml</a> 中指定的 Pod 由于 ServiceAccount 指定错误而无法调度。

请完成以下项目：

**Task:**

1. 在现有 namespace <a>prod</a> 中创建一个名为 <a>frontend-sa</a> 的新 ServiceAccount 确保此 ServiceAccount <b>不</b>自动挂载 API 凭据。
2. 使用 <a>/home/kiosk/KSCH00301/pod-manifest.yaml</a> 中的清单文件来创建一个Pod。
3. 最后，清理 namespace <a>prod</a> 中任何未使用的 ServiceAccount。

<hr>
<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>
<hr>


<img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**

1. 切换 kubernetes 集群

```bash
*$ kubectl config use-context ck8s
```

2. 查找 serviceAccount 说明中的关键字，或者参考[网页](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/)

```bash
$ kubectl explain sa | grep automount
   automountServiceAccountToken	<boolean>
```

3. 生成文件

```bash
$ kubectl -n prod create sa frontend-sa --dry-run=client -o yaml > 9.yml
```

4. 编辑

```bash
*# vim 9.yml
```

```yaml
apiVersion: v1
kind: ServiceAccount
# 增加1行
automountServiceAccountToken: false
metadata:
  # 修改两行
  name: frontend-sa
  namespace: prod
```

5. 创建 serverAccount

```bash
*$ kubectl apply -f 9.yml
```

6. 更改 pod 的 yaml

```bash
*$ vim /home/kiosk/KSCH00301/pod-manifest.yaml
```

```yaml
apiVersion: v1
kind: Pod
metadata:
# name: ""
  name: "frontend-sa"
# namespace: ""
  namespace: "prod"
spec:
# serviceAccountName: "tom"
  serviceAccountName: "frontend-sa"
  containers:
  - image: nginx:1.9
    imagePullPolicy: IfNotPresent
    name: podx
    resources: {}
status: {}
```

7. 创建 pod

```bash
*$ kubectl apply -f /home/kiosk/KSCH00301/pod-manifest.yaml
```

8. 验证已创建

```bash
$ kubectl -n prod get pods
NAME           READY   STATUS    RESTARTS   AGE
`frontend-sa`  1/1     Running   0          24s

$ kubectl -n prod describe pod frontend-sa |grep -i volumes
Volumes:           `<none>`
```

9. 列出 qa 命令空间中的 serverAccount

```bash
$ kubectl -n prod get sa
NAME            SECRETS   AGE
default         1         67m
`backend-sa`    1         66m
frontend-sa     1         2s
```

10. 删除未使用的 serviceAccount

```bash
*$ kubectl -n prod delete sa backend-sa
```

11. 验证已删除

```bash
$ kubectl -n prod get sa
NAME            SECRETS   AGE
default         1         67m
frontend-sa     1         66m
```



## Task 3. defaultNetworkPolicy-4%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>


**Context:**

一个默认拒绝（default-deny）的 NetworkPolicy 可避免在未定义任何其他 NetworkPolicy 的 namespace 中意外公开 Pod。

**Task:**

为所有类型为 <a>Ingress+Egress</a> 的流量在 namespace <a>development</a> 中创建一个名为 <a>denypolicy</a> 的新默认拒绝 NetworkPolicy。

此新的 NetworkPolicy 必须拒绝 namespace <a>development</a> 中的所有 <a>Ingress+Egress</a> 流量。

将新创建的默认拒绝 NetworkPolicy 应用于在 namespace <a>development</a> 中运行的所有 Pod。

<div style="background: #CFE2F0; padding: 12px; line-height: 24px; margin-bottom: 24px; ">
你可以在 <a>/home/kiosk/KSSH00301/network-policy.yaml</a> 找到一个模板清单文件。
</div>


PS: 

```bash
$ k explain NetworkPolicy
$ k explain NetworkPolicy.metadata
```

<hr>
<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>

<img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**

1. 切换 kubernetes 集群

```bash
*$ kubectl config use-context ck8s 
```

2. 参考官网手册编辑

```bash
*$ vim 3.yml
```

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
# name: default-deny-all
  name: denypolicy
# 增加 1 行
  namespace: development
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
```

3. 创建 networkPolicy

```bash
*$ kubectl apply -f 3.yml
networkpolicy.networking.k8s.io/denypolicy created
```

4. 验证

```bash
$ kubectl -n development get networkpolicies
NAME            POD-SELECTOR           AGE
`denypolicy`    <none>                 60s

$ kubectl -n development get networkpolicies denypolicy -o yaml
...输出省略...
  name: `denypolicy`
  namespace: `development`
...输出省略...
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
```



## Task 4. RoleBinding-6%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>

**Context**

绑定到 Pod 的 ServiceAccount 的 Role 授予过度宽松的权限。完成以下项目以减少权限集。

**Task**

一个名为 <a>test-web-pod</a> 的现有 Pod 已在 namespace <a>istio-system</a> 中运行。

编辑绑定到 Pod 的 ServiceAccount <a>service-account-web</a> 的现有 Role，**仅**允许**只**对 <a>endpoints</a> 类型的资源执行 <a>get</a> 操作。

在 namespace <a>istio-system</a> 中创建一个名为 <a>role-2</a>，并**仅**允许**只**对 <a>namespaces</a> 类型的资源执行 <a>delete</a> 操作的新 Role。

创建一个名为 <a>role-2-binding</a> 的新 RoleBinding，将新创建的 Role 绑定到 Pod 的 ServiceAccount。

<div style="background: #ffedcc; padding: 12px; line-height: 24px; margin-bottom: 24px; ">
  请勿删除现有的 RoleBinding.
</div>
<hr>
<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>
<hr>


<img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**

1. 切换集群

```bash
*$ kubectl config use-context ck8s
```

2. 查看名字空间 monitoring 中容器名称

```bash
$ kubectl -n istio-system get pods
NAME        READY   STATUS    RESTARTS   AGE
`test-web-pod`   1/1     Running   0          37s
```

3. 查找角色名称

```bash
$ kubectl -n istio-system get rolebinding -o wide
NAME			ROLE					AGE	USERS	GROUPS	SERVICEACCOUNTS
sa-dev-1	Role/`role-1`	2m13s							istio-system/service-account-web
```

4. 编辑角色

```bash
*$ kubectl -n istio-system edit role role-1
```

```yaml
...此处省略...
rules:
- apiGroups:
	- ""
	resources:
#	- pods
	- endpoints
	verbs:
# 只删除下 2 行
#	- create
#	- watch
	- get
```

5. 创建 role

```bash
*$ kubectl -n istio-system create role --help
Usage:
  kubectl create role NAME --verb=verb --resource=resource.group/subresource [--resource-name=resourcename] [--dry-run=server|client|none] [options]
 
*$ kubectl -n istio-system create role --verb=delete --resource=namespaces --dry-run=client -o yaml > role-2.yaml

*$ kubectl apply -f role-2.yaml
```

6. 创建 rolebinding

```bash
*$ kubectl -n istio-system create rolebinding --help
Usage:
  kubectl create rolebinding NAME --clusterrole=NAME|--role=NAME [--user=username] [--group=groupname]
[--serviceaccount=namespace:serviceaccountname] [--dry-run=server|client|none] [options]


*$ kubectl -n istio-system get rolebinding -owide
NAME                  ROLE          AGE   USERS   GROUPS   SERVICEACCOUNTS
service-account-web   Role/role-1   26d                    istio-system/service-account-web

*$ kubectl -n istio-system create rolebinding role-2-binding --role=role-2 --serviceaccount=istio-system:service-account-web --dry-run=client -o yaml > role-2-b.yaml

*$ kubectl apply -f  role-2-b.yaml
rolebinding.rbac.authorization.k8s.io/role-2-binding created
    
*$ kubectl -n istio-system get rolebinding -owide
NAME                  ROLE          AGE   USERS   GROUPS   SERVICEACCOUNTS
role-2-binding        Role/role-2   11s                    istio-system/service-account-web
service-account-web   Role/role-1   26d                    istio-system/service-account-web

```



## Task 5. log audit-7%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>


**Task**

在 cluster 中启用审计日志。为此，请启用日志后端，并确保：

- 日志存储在 <a>/var/log/kubernetes/logs.txt</a>
- 日志文件能保留 <a>10</a> 天
- 最多保留 <a>2</a> 个旧审计日志文件

<a>/etc/kubernetes/logpolicy/audit-policy.yaml</a> 提供了基本策略。它仅指定**不记录**的内容。

<div style="background: #CFE2F0; padding: 12px; line-height: 24px; margin-bottom: 24px; ">
    基本策略位于 cluster 的 master 节点上。
  </div>


编辑和扩展基本策略以记录：

- RequestResponse 级别的 <a>persistentvolumes</a> 更改
- namespace <a>webapps</a> 中 <a>configmaps</a> 更改的请求体
- <a>Metadata</a> 级别的所有 namespace 中的 ConfigMap 和 Secret 的更改

此外，添加一个全方位的规则以在 <a>Metadata</a> 级别记录所有其他请求。

<div style="background: #ffedcc; padding: 12px; line-height: 24px; margin-bottom: 24px;">
  不要忘记应用修改后的策略。
</div> 
<hr>
<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>
<hr>


<img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**

1. 切换 kubernetes 集群

```bash
*$ kubectl config use-context ck8s

*$ kubectl get nodes
```

2. 参考网页，按题意要求添加参数

```bash
*$ ssh root@k8s-master
```

```bash
*# vim /etc/kubernetes/manifests/kube-apiserver.yaml
```

```yaml
...此处省略...
spec:
  containers:
  - command:
    - kube-apiserver
# 增加 4 行
    - --audit-policy-file=/etc/kubernetes/logpolicy/audit-policy.yaml
    - --audit-log-path=/var/log/kubernetes/logs.txt
    - --audit-log-maxage=10
    - --audit-log-maxbackup=2
...此处省略...
    volumeMounts:
# 增加 6 行
    - mountPath: /etc/kubernetes/logpolicy/audit-policy.yaml
      name: audit
      readOnly: true
    - mountPath: /var/log/kubernetes/
      name: audit-log
      readOnly: false
  hostNetwork: true
  priorityClassName: system-node-critical
  securityContext:
    seccompProfile:
      type: RuntimeDefault
  volumes:
  ...
# 增加 8 行
  - name: audit
    hostPath:
      path: /etc/kubernetes/logpolicy/audit-policy.yaml
      type: File
  - name: audit-log
    hostPath:
      path: /var/log/kubernetes/
      type: DirectoryOrCreate
status: {}
```

3. 创建文件夹

```bash
*# mkdir /etc/kubernetes/logpolicy
```

4. 参考网页，创建策略文件

```bash
*# vim /etc/kubernetes/logpolicy/audit-policy.yaml
```

```yaml
apiVersion: audit.k8s.io/v1
kind: Policy
omitStages:
  - "RequestReceived"
rules:
  - level: RequestResponse
    resources:
    - group: ""
#     resources: ["pods"]
      resources: ["persistentvolumes"]

  - level: Request
    resources:
    - group: ""
      resources: ["configmaps"]
#   namespaces: ["kube-system"]
    namespaces: ["webapps"]

  - level: Metadata
    resources:
    - group: ""
      resources: ["secrets", "configmaps"]

  - level: Metadata
    omitStages:
      - "RequestReceived"
```

5. 重启服务

```bash
*# systemctl restart kubelet
```

6. 查找 kube-apiserver 的容器名称，并删除

<kbd>Ctrl</kbd>-<kbd>D</kbd>

7. 确认日志生成

```bash
$ sudo ls /var/log/kubernetes/
logs.txt
```



## Task 6. secret-4%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>


**Task**

在 namespace <a>db</a> 中获取名为 <a>db1-test</a> 的现有 secret 的内容。

将 <a>username</a> 字段存储在名为 <a>/home/kiosk/user.txt</a> 的文件中，并将 <a>password</a> 字段存储在名为 <a>/home/kiosk/pass.txt</a> 的文件中。

<div style="background: #CFE2F0; padding: 12px; line-height: 24px; margin-bottom: 24px; ">
  您必须创建以上两个文件；它们还不存在。
</div>


<div style="background: #ffedcc; padding: 12px; line-height: 24px; margin-bottom: 24px;">
  不要在以下步骤中使用/修改先前创建的文件，如果需要，创建新的临时文件。
</div> 


在 <a>db</a> namespace 中创建一个名为 <a>test-workflow</a> 的新 secret，内容如下：

<div style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 24px; color: #235A8B; display: table;"><dt style='float: left;'>
username: jerry<br>
  password: jjj</dt>
</div> 
最后，创建一个新的 Pod，它可以通过卷访问 secret <a>test-workflow</a>：
**Pod 名**            <a>dev-pod</a>
**Namespace**    <a>db</a>
**容器名**  			<a>test-secret-container</a>
**镜像**                <a>httpd</a>
**卷名**    			  <a>test-secret-volume</a>
**挂载路径**       <a>/etc/test-secret</a>

<hr>
<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>
<hr>



<img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**

1. 切换 kubernetes 集群

```bash
*$ kubectl config use-context ck8s
```

2. 查找关键词 / `secret`
   [使用 kubectl 管理 Secret](https://kubernetes.io/zh/docs/tasks/configmap-secret/managing-secret-using-kubectl/)
   	[解码 Secret](https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#decoding-secret)

```bash
*$ kubectl -n db get secrets -o yaml
apiVersion: v1
items:
- apiVersion: v1
  data:
    `password: dHR0`
    `username: dG9t`
    ...
```

3. 用户名解密保存

   是否需要解密？？？

```bash
*$ echo dG9t | base64 -d
   tom
   
*$ echo tom > /home/kiosk/user.txt
```

4. 密码解密保存

```bash
*$ echo dHR0 | base64 -d
   ttt
   
*$ echo ttt > /home/kiosk/pass.txt
```

5. 创建机密

```bash
*$ kubectl \
   -n db \
   create secret generic test-workflow \
   --from-literal=username=jerry \
   --from-literal=password=jjj
```

6. 编辑模板文件，可参考[官网手册](https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-secrets-as-files-from-a-pod)
   	查找关键词 / `secret`
   		[Secret | Kubernetes](https://kubernetes.io/zh/docs/concepts/configuration/secret/)
   			[在 Pod 中以文件形式使用 Secret](https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/#using-secrets-as-files-from-a-pod)

```bash
$ vim 11.yml
```

```yaml
apiVersion: v1
kind: Pod
metadata:
# name: mypod
  name: dev-pod
# 增加 1 行  
  namespace: db
spec:
  containers:
# - name: mypod
  - name: test-secret-container
#   image: redis
    image: httpd
    volumeMounts:
#   - name: foo
    - name: test-secret-volume
#     mountPath: "/etc/foo"
      mountPath: "/etc/test-secret"
      readOnly: true
  volumes:
# - name: foo
  - name: test-secret-volume
    secret:
#     secretName: mysecret
      secretName: test-workflow
      optional: false
```

8. 创建 pod

```bash
*$ kubectl apply -f 11.yaml
```

9. 确认

```bash
$ kubectl -n db get pods dev-pod -o yaml | grep image:
  - image: `httpd`
    image: `httpd`

$ kubectl -n db get pods dev-pod -o yaml | grep '\- name: test-secret-volume' -A 4
  - name: `test-secret-volume`
    secret:
      defaultMode: 420
      optional: false
      secretName: `test-workflow`
      
$ kubectl -n db exec dev-pod -- cat /etc/test-secret/username
`jerry`

$ kubectl -n db exec dev-pod -- cat /etc/test-secret/password
`jjj`
```



## Task 7. Dockerfile-6%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>
**Task**

分析和编辑给定的 Dockerfile <a>/home/kiosk/KSSC00301/Dockerfile</a>（基于 <a>ubuntu:16.04</a> 镜像）并修复在文件中拥有突出的安全/最佳实践问题的**两个指令**

分析和编辑给定的清单文件 <a>/home/kiosk/KSSC00301/deployment.yml</a> 并修复在文件中拥有突出的安全/最佳实践问题的**两个字段**。

<div style="background: #ffedcc; padding: 12px; line-height: 24px; margin-bottom: 24px;">
  请勿添加或删除配置设置；只需修改现有的配置设置让以上<b>两个</b>配置设置都不再有安全/最佳实践问题。
</div>


<div style="background: #CFE2F0; padding: 12px; line-height: 24px; margin-bottom: 24px; ">
  如果您需要非特权用户来执行任何项目，请使用用户 ID <a>65535</a> 的用户 <a>nobody</a>。
</div>
<hr>
<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>
<hr>



<img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**

1. 切换 kubernetes 集群

```bash
*$ kubectl config use-context ck8s
```

2. Dockerfile

```bash
*$ vim /home/kiosk/KSSC00301/Dockerfile
```

```dockerfile
#FROM ubuntu:latest
FROM ubuntu:16.04
...此处省略...
#USER root
USER nobody
CMD ["couchbase-server"]
...此处省略...
```

3. deployment.yaml

   > \# cks-setup 脚本 bug，手动执行下面命令
   >
   > cp /content/cks/deployment.yml /home/kiosk/KSSC00301/deployment.yml

```bash
*$ vim /home/kiosk/KSSC00301/deployment.yml
```

```yaml
...此处省略...
spec:
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: couchdb
      version: stable
...此处省略...
  template:
    metadata:
      labels:
#       run: couchdb
        app: couchdb
...此处省略...
        securityContext:
#         {'capabilities': {'add': ['NET_BIND_SERVICE', 'SYS_ADMIN'], 'drop': ['all']}, 'privileged': True, 'readonlyRootFilesystem': False, 'runAsUser': 65535}
          {'capabilities': {'add': ['NET_BIND_SERVICE', 'SYS_ADMIN'], 'drop': ['all']}, 'privileged': False, 'readonlyRootFilesystem': False, 'runAsUser': 65535}
...此处省略...
```



## Task 8. RuntimeClass-11%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>
**Context**

该 cluster 使用 <a>containerd</a> 作为 CRI 运行时。 <a>containerd</a> 的默认运行时处理程序是 <a>runc</a>。 <a>containerd</a> 已准备好支持额外的运行时处理程序 <a>runsc</a>(gVisor)。

**Task**

使用名为 <a>runsc</a> 的现有运行时处理程序，创建一个名为 <a>untrusted</a> 的 RuntimeClass。

更新 namespace <a>server</a> 中的所有 Pod 以在 gVisor 上运行。

<div style="background: #CFE2F0; padding: 12px; line-height: 24px; margin-bottom: 24px; ">
 你可以在 <a>/home/kiosk/ck8s/runtime-class.yaml</a> 找到一个模板清单文件。
</div>
<hr>
<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>
<hr>




<img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**


1. 切换 kubernetes

```bash
*$ kubectl config use-context ck8s

*$ kubectl explain runtimeclass
```

2. 参考[网页](https://kubernetes.io/zh/docs/concepts/containers/runtime-class/#2-%E5%88%9B%E5%BB%BA%E7%9B%B8%E5%BA%94%E7%9A%84-runtimeclass-%E8%B5%84%E6%BA%90)创建文件

```bash
*$ vim 13.yml
```

```yaml
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
# name: myclass
  name: untrusted
# handler: myconfiguration
handler: runsc
```

3. 创建 RuntimeClass

```bash
*$ kubectl apply -f 13.yml
```

4. 确认

```bash
$ kubectl get runtimeclass
NAME          HANDLER   AGE
`untrusted`   runsc     21s
```

5. 查看 pods

```bash
*A$ kubectl -n server get all

*B$ kubectl -n server get pods
NAME                    READY   STATUS    RESTARTS   AGE
web1-9dc5b9fd9-w8jsr    1/1     Running   0          72s
web2-5b4dcb65db-sn4bq   1/1     Running   0          72s
web3-848d7d4799-vz76w   1/1     Running   0          72s

*$ kubectl -n server get deploy
NAME   READY   UP-TO-DATE   AVAILABLE   AGE
web1   1/1     1            1           6d17h
web2   1/1     1            1           6d17h
web3   1/1     1            1           6d17h
```

6. 参考网页，编辑 deploy

```bash
$ kubectl -n server edit deploy web1
```

```yaml
...此处省略...
    spec:
      # 添加 1 行
      runtimeClassName: untrusted
      containers:
      - image: httpd
...此处省略...
```

```bash
$ kubectl -n server edit deploy web2
```

```yaml
...此处省略...
    spec:
      # 添加 1 行
      runtimeClassName: untrusted
      containers:
      - image: httpd
...此处省略...
```

```bash
$ kubectl -n server edit deploy web3
```

```yaml
...此处省略...
    spec:
      # 添加 1 行
      runtimeClassName: untrusted
      containers:
      - image: httpd
...此处省略...
```

7. 确认

```bash
$ kubectl -n server get pods -o wide
NAME                    READY   STATUS    RESTARTS   AGE     IP             NODE          NOMINATED NODE   READINESS GATES
web1-9dc5b9fd9-w8jsr    1/1     Running   0          4m44s   172.16.126.1   k8s-worker2   <none>           <none>
web2-5b4dcb65db-sn4bq   1/1     Running   0          4m44s   172.16.126.2   k8s-worker2   <none>           <none>
web3-848d7d4799-vz76w   1/1     Running   0          4m44s   172.16.126.3   k8s-worker2   <none>           <none>

$ ssh k8s-worker2 "sudo ps aux | grep httpd"
kiosk      12810  0.0  0.0   4020  2196 pts/0    S+   03:06   0:00 grep --color=auto httpd
```

> ## PS：正确的结果，看不到 httpd 进程



## Task 9. networkPolicy-6%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>
**Task**

创建一个名为 <a>pod-restriction</a> 的 NetworkPolicy 来限制对在 namespace <a>dev-team</a> 中运行的 Pod <a>users-service</a> 的访问。

只允许以下 Pod 连接到 Pod <a>users-service</a>：

- namespace <a>testing</a> 中的 Pod
- 位于任何 namespace，带有标签 <a>environment: testing</a>的 Pod

<div style="background: #ffedcc; padding: 12px; line-height: 24px; margin-bottom: 24px;">
确保应用 NetworkPolicy。
</div>


<div style="background: #CFE2F0; padding: 12px; line-height: 24px; margin-bottom: 24px;">
  你可以在 <a>/home/kiosk/KSSH00301/network-policy.yaml</a> 找到一个模板清单文件。
</div>
<hr>
<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>
<hr>


<img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**

1. 切换 kubernetes 集群

```bash
$ kubectl config use-context ck8s
```

2. 查看标签

```bash
$ kubectl -n dev-team get pods --show-labels
NAME       						 READY STATUS  RESTARTS AGE   LABELS
users-service 1/1     			 Running 0        92s  `run=users-service`

$ kubectl get ns testing --show-labels
NAME    STATUS AGE   LABELS
testing Active 16m  `kubernetes.io/metadata.name=testing`
```

3. 根据官网手册，创建并编辑yaml文件

```bash
*$ vim 9.yml
```

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
# name: test-network-policy
  name: pod-restriction
# namespace: default 
  namespace: dev-team
spec:
  podSelector:
    matchLabels:
     #role: db
      run: users-service
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          # 增加1行
          kubernetes.io/metadata.name: testing
    # 增加5行
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          environment: testing
```

4. 应用

```bash
*$ kubectl apply -f 9.yml
```

5. 测试

```bash
$ kubectl -n dev-team get networkpolicies -o yaml
apiVersion: v1
items:
- apiVersion: networking.k8s.io/v1
  kind: NetworkPolicy
  metadata:
		...输出省略...
    name: `pod-restriction`
    namespace: `dev-team`
    ...输出省略...
  spec:
    ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            `kubernetes.io/metadata.name: testing`
      - namespaceSelector: {}
        podSelector:
          matchLabels:
            `environment: testing`
    podSelector:
      matchLabels:
        `run: users-service`
    policyTypes:
    - `Ingress`
...输出省略...
```

```bash
$ kubectl -n dev-team get pods -o wide
NAME           READY STATUS  RESTARTS AGE  IP              NODE            NOMINATED NODE   READINESS GATES
users-service  1/1   Running 0        6h4m `172.16.194.67`   k8s-worker1   <none>           <none>

$ kubectl run t1 --image=nginx -n testing
$ kubectl run t2 --image=nginx

$ kubectl -n testing exec t1 -- curl -sm 1 172.16.194.67 | grep -i welcome
<title>Welcome to nginx!</title>
<h1>Welcome to nginx!</h1>

$ kubectl exec t2 -- curl -sm 1 172.16.194.67
command terminated with exit code 28

$ kubectl label pod t2 environment=testing
$ kubectl exec t2 -- curl -sm 1 172.16.194.67 | grep -i welcome
<title>Welcome to nginx!</title>
<h1>Welcome to nginx!</h1>
```



## Task 10. trivy-3%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>
**Task**

使用 Trivy 开源容器扫描器检测 namespace <a>kamino</a> 中 Pod 使用的具有严重漏洞的镜像。

查找具有 **High** 或 **Critical** 严重性漏洞的镜像，并删除使用这些镜像的Pod。

<div style="background: #ffedcc; padding: 12px; line-height: 24px; margin-bottom: 24px;">
  Trivy <b>仅</b>预装在 cluster 的 master节点上；它在原本的系统或工作节点上不可用。您必须连接到 cluster 的 master 节点才能使用 Trivy。</div>
<hr>
<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>
<hr>


<img align=left width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**

1. 切换 kubernetes 集群

```bash
*$ kubectl config use-context ck8s
```

2. 查找 master

```bash
$ kubectl get nodes
NAME          STATUS   ROLES                  AGE   VERSION
`k8s-master`  Ready    control-plane,master   12d   v1.24.1
...输出省略...
```

3. 参考网页，查看容器对应的 image

```bash
*$ ssh root@k8s-master

M1
*# kubectl -n kamino get pods -o yaml | grep image:

M2
*# kubectl -n kamino describe pods | egrep -i '^name:|image:'

M3
*# kubectl \
  -n kamino \
  get pods \
  -o=custom-columns="NAME:.metadata.name,IMAGE:.spec.containers[*].image"
NAME        IMAGE
baby-yoda   `ubuntu`
r2d2        `ubuntu`
rex					`alpine:3.10.7`
yoda				`alpine:3.10.7`
```

4. 查看

   > \# 如果有云主机/aws/日本
   >
   > wget https://github.com/aquasecurity/trivy/releases/download/v0.42.1/trivy_0.42.1_Linux-64bit.deb
   > sudo dpkg -i trivy_0.42.1_Linux-64bit.deb
   >
   > \# 考试环境中， DB已更新

```bash
# trivy -h
USAGE:
   trivy [global options] command [command options] target
...输出省略...
COMMANDS:
   `image`, i          scan an image
...输出省略...
   `help`, h           Shows a list of commands or help for one command
...输出省略...

# trivy help image
...输出省略...
   --severity value, -s value       severities of vulnerabilities to be displayed (comma separated) (default: "UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL") [$TRIVY_SEVERITY]
   
*# trivy image -s HIGH,CRITICAL ubuntu
...输出省略...
ubuntu (ubuntu 20.04)
=====================
Total: 14 (UNKNOWN: 0, LOW: 12, MEDIUM: 2, HIGH: `0`, CRITICAL: `0`)
...输出省略...

*# trivy image -s HIGH,CRITICAL alpine:3.10.7
...输出省略...
alpine:3.10.7 (alpine 3.10.7)
=============================
Total: 4 (UNKNOWN: 0, LOW: 0, MEDIUM: 0, HIGH: `3`, CRITICAL: `1`)
...输出省略...
```

<kbd>Ctrl</kbd>-<kbd>D</kbd>

5. 删除容器

```bash
*$ kubectl -n kamino delete pod rex yoda
pod "rex" deleted
pod "yoda" deleted
```



## Task 11. AppArmor-11%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>


**Context**

AppArmor 已在 cluster 的工作节点上被启用。一个 AppArmor 配置文件已存在，但尚未被实施。

<div style="background: #CFE2F0; padding: 12px; line-height: 24px; margin-bottom: 24px; ">
  您可以使用浏览器打开一个<b>额外的标签页</b>来访问 <a>AppArmor的文档</a>。
</div>


**Task**

在 cluster 的工作节点上，实施位于 <a>/etc/apparmor.d/nginx_apparmor</a> 的现有 AppArmor 配置文件。

编辑位于 <a>/home/kiosk/KSSH00401/nginx-ds.yaml</a> 的现有清单文件以应用 AppArmor 配置文件。

最后，应用清单文件并创建其中指定的 Pod。

<hr>
<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>
<hr>



<img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**

1. 切换集群

```bash
*$ kubectl config use-context ck8s
```

2. 确认 nodes

```bash
*$ kubectl get nodes
```

3. 登陆 worker1

```bash
*$ ssh root@k8s-worker1
```

4. 查看配置名称

```bash
*# head /etc/apparmor.d/nginx_apparmor
#include <tunables/global>
profile `nginx-profile-3` flags=(attach_disconnected) {
...输出省略...
```

```bash
*# apparmor_status | grep profile
6 profiles are loaded.
38 profiles are in enforce mode.
38 profiles are in complain mode.
11 processes have profiles defined.
5 processes are unconfined but have a profile defined.

*# apparmor_parser /etc/apparmor.d/nginx_apparmor

# apparmor_status | grep profile
77 profiles are loaded.
39 profiles are in enforce mode.
  `nginx-profile-3`
38 profiles are in complain mode.
11 processes have profiles defined.
5 processes are unconfined but have a profile defined.
```

 <kbd>Ctrl</kbd>-<kbd>D</kbd>

5. 参考网页编辑

```bash
*$ vim /home/kiosk/KSSH00401/nginx-ds.yaml
```

```yaml
apiVersion: v1
kind: Pod
metadata:	
	name: podx
# 增加2行
	annotations:
    container.apparmor.security.beta.kubernetes.io/busybox: localhost/nginx-profile-3
spec:
  containers:
  - name: busybox
    image: busybox:1.28
    command: [ "sh", "-c", "echo 'Hello AppArmor!' && sleep 2h" ]
  nodeSelector:
    kubernetes.io/hostname: k8s-worker1
```

6. 创建 pod

```bash
*$ kubectl apply -f /home/kiosk/KSSH00401/nginx-ds.yaml
```

7. 确认

```bash
$ kubectl get pods

$ kubectl exec -it podx -- touch /tmp/new.txt
touch: /tmp/new.txt: Permission denied
```



## Task 12. sysdig-14%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>
<div style="background: #CFE2F0; padding: 12px; line-height: 24px; margin-bottom: 24px; ">
  您可以使用浏览器打开一个<b>额外的标签页</b>来访问 <a>Falco 的文档</a>。
</div>


**Task**

使用运行时检测工具来检测  Pod <a>tomcat</a> 单个容器中频发生成和执行的异常进程。

有两种工具可供使用：

- <a>sysdig</a>
- <a>falco</a>

注： 这些工具**只**预装在cluster的工作节点 <a>worker1</a> 上，不在 master 节点

使用工具至少分析30秒 ，使用过滤器检查生成和执行的进程，将事件写到 <a>/opt/KSRS00101/alerts/details</a> 文件中， 

其中包含检测的事件， 格式如下： 

<div style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 24px; color: #235A8B; display: table;"><dt style='float: left;'>
  timestamp,uid,processName</dt>
</div>


以下示例显示了格式正确的事件文件：

<div style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 24px; color: #235A8B;  display: table;"><dt style='float: left;'>
01:40:19.601363716,root,init<br>
01:40:20.606013716,nobody,bash<br>
  01:40:21.137163716,1000,tar</dt>
</div>
<div style="background: #CFE2F0; padding: 12px; line-height: 24px; margin-bottom: 24px; ">
   保持工具的原始时间戳格式不变。
  </div>

<div style="background: #F9DBD8; padding: 12px; line-height: 24px; margin-bottom: 24px; ">
注： 确保事件文件存储在集群的工作节点上。
</div>


<hr>
<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>



<img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**

1. 切换集群

```bash
*$ kubectl config use-context ck8s
```

2. 查找 node

```bash
$ kubectl get nodes
NAME            STATUS   ROLES                  AGE   VERSION
k8s-master      Ready    control-plane,master   11d   v1.25.1
`k8s-worker1`   Ready    <none>                 11d   v1.25.1
```

3. 远程 node

```bash
*$ ssh root@k8s-worker1
```

4. 查找容器

```bash
*# crictl info | grep sock
    "containerdEndpoint": "/run/containerd/containerd.sock",
```

5. 查看

```bash
30s
# sysdig --help | grep \\-M
 `-M` <num_seconds>   Stop collecting after <num_seconds> reached.

运行时
# sysdig --help | grep \\--cri
 `--cri` <path>       Path to CRI socket for container metadata
 
变量
# sysdig --help | grep \\-p
 `-p` outputformat, --print=outputformat
 
# sysdig --help | grep \\-l
 -l, --list         List the fields that can be used for filtering and output

# sysdig -l | grep time
`evt.time`  event timestamp as a time string that includes the nanosecond part.
# sysdig -l | grep ^user
`user.uid`	user ID.
`user.name`	user name.
# sysdig -l | grep ^proc
`proc.name`	the name (excluding the path) of the executable generating the event.
```

6. 创建文件夹

```bash
*# mkdir -p /opt/KSRS00101/alerts
```

7. 生成日志

   > sysdig -h | tail -n 2
   >    $ sysdig -p"%evt.arg.name" proc.name=cat and evt.type=open
   >
   > \# 练习环境中，image原因未生事件
   >
   > k8s-master$ k exec -it tomcat -- ls -l

```bash
*# sysdig \
	-M 30 \
	--cri /run/containerd/containerd.sock \
	container.name=tomcat \
	-p "%evt.time,%user.uid,%proc.pname" \
	> /opt/KSRS00101/alerts/details
```

8. 确认

```bash
# head -n 1 /opt/KSRS00101/alerts/details; \
  tail -n 1 /opt/KSRS00101/alerts/details
```

<kbd>Ctrl</kbd>-<kbd>D</kbd>

## Task 13. Container 安全上下文-%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>


**Context**

Container Security Context 应在特定 namespace 中修改 Deployment。

**Task**

按照如下要求修改 <a>sec-ns</a> 命名空间里的 Deployment <a>secdep</a>

1. 用 ID 为 <a>30000</a> 的用户启动容器（设置用户 ID 为: 30000）
2. 不允许进程获得超出其父进程的特权（禁止 allowPrivilegeEscalation）
3. 以只读方式加载容器的根文件系统（对根文件的只读权限）

<hr>
<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>



<img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**

1. 切换 kubernetes 集群

```bash
*$ kubectl config use-context ck8s

*$ kubectl explain pod.spec.containers.securityContext --recursive
```

2. 编辑 deploy

```bash
注意看清楚deployment里面有几个容器
$ kubectl -n sec-ns edit deployment secdep
```

```yaml
...
  template:
    ...
    spec:
      containers:
      - command:
        ...
        resources: {}
        # 增加 4 行
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsUser: 30000
        terminationMessagePath: /dev/termination-log
        ...
      - command:
        ...
        resources: {}
        # 增加 4 行
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsUser: 30000
        terminationMessagePath: /dev/termination-log
        ...
```

3. 确认

```bash
$ k -n sec-ns exec -it secdep-5dcddff969-rdtb8 -c sec1 -- id
uid=30000 gid=0(root) groups=0(root)

$ k -n sec-ns exec -it secdep-5dcddff969-rdtb8 -c sec2 -- id
uid=30000 gid=0(root) groups=0(root)

$ k -n sec-ns exec -it secdep-5dcddff969-rdtb8 -c sec1 -- touch /ro.txt
touch: /ro.txt: Read-only file system
command terminated with exit code 1

$ k -n sec-ns exec -it secdep-5dcddff969-rdtb8 -c sec2 -- touch /ro.txt
touch: /ro.txt: Read-only file system
command terminated with exit code 1

$ k -n sec-ns exec -it secdep-5dcddff969-rdtb8 -c sec1 -- su
su: must be suid to work properly
command terminated with exit code 1

$ k -n sec-ns exec -it secdep-5dcddff969-rdtb8 -c sec2 -- su
su: must be suid to work properly
command terminated with exit code 1
```



## Task 14. 启用 API server 认证-6%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>



**Context**

由 <a>kubeadm</a> 创建的 cluster 的 Kubernetes API服务器，出于测试目的，临时配置为允许未经身份验证和未经授权的访问，授予匿名用户cluster-admin 的访问权限。

**Task**

重新配置 cluster 的 Kubernetes API 服务器以确保只允许经过身份验证和授权的 REST 请求。

使用授权模式 <a>Node,RBAC</a> 和准入控制器 <a>NodeRestriction</a>。

删除用户 <a>system:anonymous</a> 的 ClusterRoleBinding 来进行清理。

<div style="background: #ffedcc; padding: 12px; line-height: 24px; margin-bottom: 24px;">
  所有 <a>kubectl</a> 配置环境/文件也被配置为使用未经身份验证和未经授权的访问。您不必更改它，但请注意，一旦完成 cluster 的安全加固，<a>kubectl</a> 的配置将无法工作。
</div> 
<div style="background: #C3E4F2; padding: 12px; line-height: 24px; margin-bottom: 24px; ">
  您可以使用位于 cluster 的 master 节点上，cluster 原本的<a>kubectl</a> 配置文件 <a>/etc/kubernetes/admin.conf</a>，以确保经过身份验证和授权的请求仍然被允许。
</div>
<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> kiosk@k8s-master:~$ <b>cks-setup 14</b>
</div>
<hr>
<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>



<img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**

1. 切换 kubernetes 集群

```bash
*$ kubectl config use-context ck8s
```

2. 按题意要求，编辑kube-apiserver.yaml

```bash
*$ ssh root@k8s-master

*# vim /etc/kubernetes/manifests/kube-apiserver.yaml
```

```yaml
...输出省略...
#	- --authorization-mode=AlwaysAllow
	- --authorization-mode=Node,RBAC
# - --enable-admission-plugins=AlwaysAdmit
  - --enable-admission-plugins=NodeRestriction
# == 需确认下 2 条存在
  - --client-ca-file=/etc/kubernetes/pki/ca.crt
  - --enable-bootstrap-token-auth=true
...输出省略...
```

3. 重启生效

```bash
# systemctl restart kubelet
```

4. 出现 ==Unauthorized== 提示，重新复制配置文件

```bash
# kubectl config --help
...输出省略...
  1.  If the `--kubeconfig` flag is set, then only that file is loaded. The flag
may only be set once and no merging takes place.
  2.  If `$KUBECONFIG` environment variable is set, then it is used as a list of
paths (normal path delimiting rules for your system). These paths are merged.
When a value is modified, it is modified in the file that defines the stanza.
When a value is created, it is created in the first file that exists. If no
files in the chain exist, then it creates the last file in the list.
  3.  Otherwise, `${HOME}/.kube/config` is used and no merging takes place.
...输出省略...
```

```bash
# kubectl get pods \
  || cp /etc/kubernetes/admin.conf ~/.kube/config
```

5. 查找相关 clusterrolebindings 名称

```bash
# kubectl get clusterrolebindings -o wide | grep system:anonymous
`crb1`		ClusterRole/cluster-admin	1h system:anonymous
`crb2`		ClusterRole/cluster-admin	1h system:anonymous
```

6. 删除

```bash
# kubectl delete clusterrolebinding crb1 crb2
clusterrolebinding.rbac.authorization.k8s.io "crb1" deleted
clusterrolebinding.rbac.authorization.k8s.io "crb2" deleted
```



## Task 15. TLS 安全配置-%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>



**Task**

通过 TLS 加强 kube-apiserver 安全配置，要求

1. kube-apiserver 除了 <a>VersionTLS13</a> 及以上的版本可以使用，其他版本都不允许使用
2. 密码套件（Cipher suite）为 <a>TLS_AES_128_GCM_SHA256</a>

通过 TLS 加强 ETCD 安全配置，要求

1. 密码套件（Cipher suite）为 <a>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</a>

<hr>
<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>

<img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**

1. 切换 kubernetes 集群

```bash
*$ kubectl config use-context ck8s
```

2. 按题意要求，编辑 kube-apiserver.yaml

   > $ kubectl -n kube-system exec kube-apiserver-k8s-master -- kube-apiserver --help
   >
   > 官网手册中搜索「[kube-apiserver](https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-apiserver/)」

```bash
*$ ssh root@k8s-master

*# vim /etc/kubernetes/manifests/kube-apiserver.yaml
```

```yaml
...输出省略...
    - kube-apiserver
    # 增加 2 行，或是修改
    - --tls-min-version=VersionTLS13
	  - --tls-cipher-suites=TLS_AES_128_GCM_SHA256
...输出省略...
```

3. 按题意要求，编辑 etcd.yaml

```bash
# kubectl -n kube-system \
  exec etcd-k8s-master \
  -- etcd --help \
  | grep -i cipher
--cipher-suites ''

*# vim /etc/kubernetes/manifests/etcd.yaml
```

```bash
...
    - etcd
    # 增加 1 行，或是修改
    - --cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
...
```

4. 重启生效

   > 静态pod，由 kubelet 服务维护
   >
   > 当 yaml 有变化， kubelet 服务会自动删除重建对应的静态 pod 

```bash
MA
等一会，自动生效

MB
# systemctl restart kubelet

MC
# kubectl -n kube-system \
  delete pod etcd-k8s-master kube-apiserver-k8s-master
```

5. 验证

```bash
# ps -aux | grep apiserver | grep tls
root      169323  4.6  4.0 1112188 331348 ?      Ssl  05:57   0:23 kube-apiserver `--tls-min-version=VersionTLS13 --tls-cipher-suites=TLS_AES_128_GCM_SHA256` ...

# ps -aux | grep etcd.*cipher
root      173565  6.8  0.5 11214528 44944 ?      Ssl  06:04   0:00 etcd `--cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256` ...
```

<kbd>Ctrl</kbd>-<kbd>D</kbd>



## Task 16. ingress-11%

<div style="background: #F9DBD8; padding: 12px; margin-bottom: 24px;">
  您<b>必须</b>在以下 cluster /节点上完成此考考题：<br>
  <dl style="margin-bottom: 74px;">
    <dt style="float: left; width: 33%;"><b>Cluster</b></dt>
    <dt style="float: left; width: 33%;"><b>Master 节点</b></dt>
    <dt style="float: left; width: 33%;"><b>工作节点</b></dt>
<dt style="float: left; width: 33%;"><a>ck8s</a>
<dt style="float: left; width: 33%;"><a>ck8s-master</a></dt>
<dt style="float: left; width: 33%;"><a>ck8s-worker1</a></dt>
  </dl>
您可以使用以下命令来切换 cluster / <b>配置环境</b>：
<dt style="background: #EFEFEF; padding: 12px; line-height: 24px; margin-bottom: 6px; margin-top: 6px;" >
  [kiosk@cli]$ <a>kubectl config use-context ck8s</a>
  </dt>
</div>

**Context**

cluster 上设置了容器镜像扫描器，但尚未完全集成到 cluster 的配置中。完成后，容器镜像扫描器应扫描并拒绝易受攻击的镜像的使用。

**Task**

<div style="background: #F9DBD8; padding: 12px; line-height: 24px; margin-bottom: 24px;">
您必领在 cluster 的 master 节点上完成整个考题，所有服务和文件都已被准备好并放置在该节点上。
</div> 

给定一个目录 <a>/etc/kubernetes/controlconf</a> 中不完整的配置以及具有 HTTPS 端点 <a>http://acme.local:8080/image_policy</a> 的功能性容器镜像扫描器：
1. 启用必要的插件来创建镜像策略
2. 校验控制配置并将其更改为隐式拒绝（implicit deny）
3. 编辑配置以正确指向提供的 HTTPS端点

最后，通过尝试部署易受攻击的资源 <a>/root/KSSC00202/configuration-test.yaml</a>来测试配置是否有效。

<div style="background: #CFE2F0; padding: 12px; line-height: 24px; margin-bottom: 24px; ">
  您可以在 <a>/var/log/imagepolicy/acme.log</a> 找到容器镜像扫描仪的日志文件。
</div>
<div style="background: #dbfaf4; padding: 12px; line-height: 24px; margin-bottom: 24px;">
<dt style="background: #1abc9c; padding: 6px 12px; font-weight: bold; display: block; color: #fff; margin: -12px; margin-bottom: -12px; margin-bottom: 12px;" >Hint - 提示</dt>
  <li> 考试时是 https
  <li> 考试时和练习环境的 image 不同，练习环境中设置的是不允许使用最新的 image
  <li> kiosk@k8s-master:~$ <b>cks-setup 16</b>
</div>
<hr>
<div style='background: #113362; padding: 12px; margin-bottom: 24px; display: table; width: 100%'>
 <dt style="background: #4198C7; padding: 6px; line-height: 20px; color: #FFFFFF; weight: 40px; float: left;">Readme</dt>
 <dt style="background: #307195; padding: 6px; line-height: 20px; color: #FFFFFF; float: left;">>_Web Terminal</dt>
  <dt style="padding: 6px; line-height: 20px; color: #FFFFFF; float: right;"><b>参考答案</b></dt>
</div>
<hr>



<img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>**[kiosk@cli]**

1. 切换集群

```bash
*$ kubectl config use-context ck8s

*$ kubectl get nodes
```

2. 登陆 master

```bash
*$ ssh root@k8s-master
```

3. 编辑 kube-apiserver.yaml

```bash
*# vim /etc/kubernetes/manifests/kube-apiserver.yaml
```

```yaml
...此处省略...
spec:
  containers:
  - command:
    - kube-apiserver
    - --advertise-address=192.168.147.129
    - --allow-privileged=true
    - --authorization-mode=Node,RBAC
    - --client-ca-file=/etc/kubernetes/pki/ca.crt
#   - --enable-admission-plugins=NodeRestriction
    - --enable-admission-plugins=NodeRestriction,ImagePolicyWebhook
# == 考试时不用修改(已经增加 1 行)
    - --admission-control-config-file=/etc/kubernetes/controlconf/admission_configuration.json
...此处省略...
# == 考试时不用修改(已经增加 3 行)
    - mountPath: /etc/kubernetes/controlconf
      name: config
      readOnly: true
  hostNetwork: true
  priorityClassName: system-node-critical
  securityContext:
    seccompProfile:
      type: RuntimeDefault
  volumes:
# == 考试时不用修改(已经增加 4 行)
  - hostPath:
      path: /etc/kubernetes/controlconf
      type: DirectoryOrCreate
    name: config
...此处省略...
```

4. 编辑 admission 配置文件

```bash
# vim /etc/kubernetes/controlconf/admission_configuration.json
```

```json
{
  "imagePolicy": {
// == 考试时不用修改(配置文件已修改)
    "kubeConfigFile": "/etc/kubernetes/controlconf/kubeconfig.yaml",
    "allowTTL": 50,
    "denyTTL": 50,
    "retryBackoff": 500,
//  "defaultAllow": true
    "defaultAllow": false
  }
}
```

5. 编辑 kubeconfig 文件

```bash
*# vim /etc/kubernetes/controlconf/kubeconfig.yaml
```

```yaml
apiVersion: v1
kind: Config
clusters:
-	cluster:
# == 考试时不用修改(服务器证书已添加)
		certificate-authority: /etc/kubernetes/controlconf/webhook.pem
#		server:
		server: http://acme.local:8080/image_policy
	name: bouncer_webhook
contexts:
- context:
		cluster: bouncer_webhook
		user: api-server
	name: bouncer_validator
current-context: bouncer_validator
preferences: {}
users:
- name: api-server
	user:	
# == 考试时不用修改(用户证书已修改)
		client-certificate: /etc/kubernetes/controlconf/apiserver-client.pem
		client-key: /etc/kubernetes/controlconf/apiserver-clientkey.pem
```

6. 生效

```bash
*# systemctl restart kubelet
```

7. `考试时，可创建、但无法运行`；练习环境不可创建

```bash
*# kubectl apply -f /root/KSSC00202/configuration-test.yaml
Error from server (Forbidden): error when creating "/root/KSSC00202/vulnerable-manifest.yaml": pods "pod1" is forbidden: image policy webhook backend denied one or more images: `Images using latest tag are not allowed`
```

8. 确认

```bash
# kubectl run w1 --image=nginx:1.21
pod/w1 created

# kubectl get pods
NAME   READY   STATUS    RESTARTS   AGE
w1     1/1    `Running`   0          42s
```



# <strong style='color: #00B9E4'>附录</strong>

## A0. 培训环境转练习环境

| STEP | ITEM                                                         |       COMMENT       |
| :--: | :----------------------------------------------------------- | :-----------------: |
|  1   | all vmware 快照恢复 ==1.26==                                 |      快照恢复       |
|  2   | all 虚拟机 启动                                              |     启动虚拟机      |
|  3   | <img width=36 src='https://img-blog.csdnimg.cn/c907491d5a194ed3932526302c5cfa73.png'>K8s-master<br>        CD/DVD[SATA]<br> ==cks-2304212206.iso== |    连接光盘镜像     |
|  4   | <img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'>k8s-master$ ==sudo mount /dev/sr0 /mnt== |        挂载         |
|  5   | <img width=36 src='https://img-blog.csdnimg.cn/8216009d9ce6401cbb34b83c4a8cf358.png'> K8s-master$ ==/mnt/cks-setup== |  练习环境设置脚本   |
|  6   | k get nodes && k get pod -A \| grep -v Run                   | grep -v Run确认状态 |
|  7   | <img width=36 src='https://img-blog.csdnimg.cn/c907491d5a194ed3932526302c5cfa73.png'> 做个关机快照*3（master，worker1，2） |      建议 CKS       |

## A1. exam-grade

- 单题判分 **[kiosk@k8s-master]**

```bash
$ cks-grade 1

 Spend Time: up 15m, YYYY-mm-dd Sun HH:MM
===============================================================
 `FAIL` Task1- enable-admission-plugins not include NodeRestriction
===============================================================
 The results of your CKA v1.25:  FAIL  Your score: `0`
```

```bash
$ cks-grade 2

 Spend Time: up 30m, YYYY-mm-dd Sun HH:MM
===============================================================
 `PASS` Task2. sysDig 检测 pod
===============================================================
 The results of your CKA v1.25:  FAIL  Your score: `7`
```

- 整体判分 **[kiosk@k8s-master]**

  > `1`,`5`,`14` 这三个题都需要修改 ==/etc/kubernetes/manifests/kube-apiserver.yaml==
  >
  > 考试时每个题一个集群，互相不冲突；练习环境只有一个集群

```bash
$ cks-grade

 Spend Time: up 1h23m, YYYY-mm-dd Sun HH:MM
===============================================================
 FAIL Task1- enable-admission-plugins not include NodeRestriction
 PASS Task2. sysDig 检测 pod
 PASS Task3. clusterRole
 PASS Task4. apparmor
 PASS Task5. PodSecurityPolicy
 PASS Task6. NetworkPolicy
 PASS Task7. Dockerfile and Yaml
 PASS Task8. stateless
 PASS Task9. 创建 SA
 PASS Task10. trivy 检测镜像安全
 PASS Task11. 创建 secret
 PASS Task12. kube-bench
 PASS Task13. gVisor-deploy
 PASS Task14. audit
 PASS Task15. default Network Policy
 PASS Task16. Authorization Authorization Admission
===============================================================
 The results of your CKA v1.26:  `PASS`  Your score: `90`
```



## A2. vimrc

|  ID  | FILE       | COMMENT      |
| :--: | ---------- | ------------ |
|  1   | /etc/vimrc | 所有用户有效 |
|  2   | ~/.vimrc   | 当前用户有效 |

```bash
$ echo set number ts=2 et sw=2 cuc > ~/.vimrc
```
> - set ==number==	显示行号
>   - ==ts==		TabStop	<kbd>Tab</kbd>\*1=<kbd>Space</kbd>*2
>   - ==et==		ExpandTab	扩展Tab，显示两个空格，写入文件中同
>   - ==sw==	  针对<kbd>V</kbd>,<kbd>></kbd>|<kbd><</kbd>
>   - ==cuc==	CusorColumn，光标列对齐



## A3. grep

> -r recusive 递归
>
> Usage: grep -r KEY FOLDER

```bash
$ grep -r 4.2.1  /etc
```



## A4. ChangeLog

```bash
* 1.27  Fri Jun 30 2023
- UPDATE T3
- UPDATE T4
- UPDATE T5

* 1.25
- ADD T13, T15
- DEL PSP, Statefull
```



## A5. VMnet8

- Windows

  > VMware『编辑』菜单，网络编辑器，vmnet8

- macOS

  ```zsh
  $ sudo sed -i.bk "/8.*SUB/s/SUBNET.*/SUBNET 192.168.147.0/" /Library/Preferences/VMware\ Fusion/networking
  ```

  > 完成退出 VMware（大退），重新打开
