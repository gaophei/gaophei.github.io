**Oracle11g RAC for Centos6.10 安装手册**



## 1.系统环境
### 1.1. 系统版本：
```
[root@oracle1 Packages]# cat /etc/redhat-release
CentOS release 6.10 (Final)
```
### 1.2. ASM 磁盘组规划
```
ASM 磁盘组 用途 大小 冗余
ocr、 voting file   10G+10G+10G NORMAL
DATA 数据文件 500G*2 EXTERNAL
FRA    归档日志 500G*2 EXTERNAL
```
### 1.3. 主机网络规划

#IP规划
```
网络配置               节点 1                               节点 2
主机名称               oracle1                             oracle2
public ip            172.17.5.101                        172.17.5.102
private ip           192.168.202.11                      192.168.202.12
vip                  172.17.5.103                        172.17.5.104
scan ip              172.17.5.105
```
#网卡配置
```bash
ifconfig
#nmcli参数与centos7不同
nmcli con list
#如果发现虚拟机为克隆模式，两台服务器eth0的uuid相同，重新生成新的UUID
#uuidgen eth0
#然后修改/etc/sysconfig/network-scripts/ifcfg-eth0中的UUID
#创建eth1，并修改相关内容
#cp /etc/sysconfig/network-scripts/ifcfg-eth0  /etc/sysconfig/network-scripts/ifcfg-eth1

#重启网卡，没有报错的时候可以reboot下
#systemctl restart network
```
#网卡的相关配置
#oracle1
```
[root@oracle1 ~]# cd /etc/sysconfig/network-scripts/
[root@oracle1 network-scripts]# cat ifcfg-eth0
DEVICE=eth0
TYPE=Ethernet
UUID=08bc6689-bb1f-4644-bae6-08bd266a1c25
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=none
IPADDR=172.17.5.101
PREFIX=24
GATEWAY=172.17.5.1
DNS1=8.8.8.8
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME="System eth0"
HWADDR=00:50:56:A0:91:3A
[root@oracle1 network-scripts]# cat ifcfg-Auto_eth1
TYPE=Ethernet
BOOTPROTO=none
IPADDR=192.168.202.11
PREFIX=24
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME="Auto eth1"
UUID=f5103e6e-405e-42e8-945f-cf12d3409662
ONBOOT=yes
HWADDR=00:50:56:A0:AF:96
LAST_CONNECT=1629647581
[root@oracle1 network-scripts]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
172.17.5.0      0.0.0.0         255.255.255.0   U     1      0        0 eth0
192.168.202.0   0.0.0.0         255.255.255.0   U     1      0        0 eth1
0.0.0.0         172.17.5.1      0.0.0.0         UG    0      0        0 eth0
[root@oracle1 network-scripts]# ip route
172.17.5.0/24 dev eth0  proto kernel  scope link  src 172.17.5.101  metric 1
192.168.202.0/24 dev eth1  proto kernel  scope link  src 192.168.202.11  metric 1
default via 172.17.5.1 dev eth0  proto static
[root@oracle1 network-scripts]# cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 8.8.8.8

[root@oracle1 network-scripts]# nmcli con list
名称                      UUID                                   类型              范围     真实时间戳
Auto eth1                 f5103e6e-405e-42e8-945f-cf12d3409662   802-3-ethernet    系统     2022年02月23日 星期三 10时02分43秒
System eth0               08bc6689-bb1f-4644-bae6-08bd266a1c25   802-3-ethernet    系统     2022年02月23日 星期三 10时02分43秒

[root@oracle1 network-scripts]# cat /etc/udev/rules.d/70-persistent-net.rules
# This file was automatically generated by the /lib/udev/write_net_rules
# program, run by the persistent-net-generator.rules rules file.
#
# You can modify it, as long as you keep each rule on a single
# line, and change only the value of the NAME= key.

# PCI device 0x15ad:0x07b0 (vmxnet3)
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="00:50:56:a0:91:3a", ATTR{type}=="1", KERNEL=="eth*", NAME="eth0"

# PCI device 0x15ad:0x07b0 (vmxnet3)
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="00:50:56:a0:af:96", ATTR{type}=="1", KERNEL=="eth*", NAME="eth1"
```

#oracle2
```
[root@oracle2 ~]# cd /etc/sysconfig/network-scripts/
[root@oracle2 network-scripts]# cat ifcfg-eth0
DEVICE=eth0
TYPE=Ethernet
UUID=ab0cc360-378e-4ec3-878e-751d1c0db663
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=none
HWADDR=00:50:56:A0:B0:00
IPADDR=172.17.5.102
PREFIX=24
GATEWAY=172.17.5.1
DNS1=8.8.8.8
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME="System eth0"
[root@oracle2 network-scripts]# cat ifcfg-Auto_eth1
HWADDR=00:50:56:A0:24:17
TYPE=Ethernet
BOOTPROTO=none
IPADDR=192.168.202.12
PREFIX=24
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME="Auto eth1"
UUID=18549936-5ca3-436f-9a6a-56174eaedf9a
ONBOOT=yes
LAST_CONNECT=1629647618
[root@oracle2 network-scripts]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
172.17.5.0      0.0.0.0         255.255.255.0   U     1      0        0 eth0
192.168.202.0   0.0.0.0         255.255.255.0   U     1      0        0 eth1
0.0.0.0         172.17.5.1      0.0.0.0         UG    0      0        0 eth0
[root@oracle2 network-scripts]# ip route
172.17.5.0/24 dev eth0  proto kernel  scope link  src 172.17.5.102  metric 1
192.168.202.0/24 dev eth1  proto kernel  scope link  src 192.168.202.12  metric 1
default via 172.17.5.1 dev eth0  proto static
[root@oracle2 network-scripts]# cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 8.8.8.8

[root@oracle2 network-scripts]# nmcli con list
名称                      UUID                                   类型              范围     真实时间戳
Auto eth1                 18549936-5ca3-436f-9a6a-56174eaedf9a   802-3-ethernet    系统     2022年02月23日 星期三 10时05分43秒
System eth0               ab0cc360-378e-4ec3-878e-751d1c0db663   802-3-ethernet    系统     2022年02月23日 星期三 10时05分43秒

[root@oracle2 network-scripts]# cat /etc/udev/rules.d/70-persistent-net.rules
# This file was automatically generated by the /lib/udev/write_net_rules
# program, run by the persistent-net-generator.rules rules file.
#
# You can modify it, as long as you keep each rule on a single
# line, and change only the value of the NAME= key.

# PCI device 0x15ad:0x07b0 (vmxnet3)
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="00:50:56:a0:b0:00", ATTR{type}=="1", KERNEL=="eth*", NAME="eth0"

# PCI device 0x15ad:0x07b0 (vmxnet3)
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="00:50:56:a0:24:17", ATTR{type}=="1", KERNEL=="eth*", NAME="eth1"
```

### 1.4. 操作系统配置部分

#关闭防火墙
```bash
service iptables stop
chkconfig iptables off

service iptables status
iptables -nL
chkconfig iptables --list
```
#关闭 selinux
```bash
sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config

setenforce 0
getenforce
```

## 2.准备工作（oracle1 与 oracle2 同时配置）

### 2.1. 配置本地 yum 源--可选

#挂载光驱
```bash
mount -t auto /dev/cdrom /mnt
```
#配置本地源
```bash
cat >> CentOS-Media.repo <<EOF

[c6-media]
name=CentOS-$releasever - Media
baseurl=file:///mnt/
gpgcheck=0
enabled=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-6
EOF


yum clean all

yum makecache
```
### 2.2. 安装 rpm 依赖包

#官网为准
```bash
yum update -y 

yum install -y binutils
yum install -y compat-libcap1
yum install -y compat-libstdc++-33
yum install -y compat-libstdc++-33.i686
yum install -y gcc
yum install -y gcc-c++
yum install -y glibc
yum install -y glibc.i686
yum install -y glibc-devel
yum install -y glibc-devel.i686
yum install -y ksh
yum install -y libgcc
yum install -y libgcc.i686
yum install -y libstdc++
yum install -y libstdc++.i686
yum install -y libstdc++-devel
yum install -y libstdc++-devel.i686
yum install -y libaio
yum install -y libaio.i686
yum install -y libaio-devel
yum install -y libaio-devel.i686
yum install -y make
yum install -y sysstat
yum install -y unixODBC
yum install -y unixODBC-devel

```
### 2.3. 创建用户

```bash
groupadd -g 1000 oinstall
groupadd -g 1001 dba
groupadd -g 1002 oper
groupadd -g 1003 asmadmin
groupadd -g 1004 asmdba
groupadd -g 1005 asmoper

useradd -g oinstall -G asmadmin,asmdba,asmoper,oper,dba grid

useradd -g oinstall -G dba,oper,asmdba oracle

passwd oracle
passwd grid
```
### 2.4. 配置 host 表

#hosts 文件配置
#hostname
```bash
#oracle1
hostname oracle1

vi /etc/sysconfig/network
#添加以下内容
HOSTNAME=oracle1
nozeroconf=yes

#oracle2
hostname oracle2

vi /etc/sysconfig/network
#添加以下内容
HOSTNAME=oracle2
nozeroconf=yes

#配置/etc/hosts
cat >> /etc/hosts <<EOF
#public ip eth0
172.17.5.101 oracle1
172.17.5.102 oracle2
#vip
172.17.5.103 oracle1-vip
172.17.5.104 oracle2-vip
#private ip eth1
192.168.202.11 oracle1-prv
192.168.202.12 oracle2-prv
#scan ip
172.17.5.105 rac-scan
EOF

```
### 2.5. 禁用 NTP

#检查两节点时间，时区是否相同
```bash
date
```
#如果不一致，则校时:
```bash
rdate -s time.nist.gov
```

#禁止 ntp
```bash
service ntpd stop
chkconfig ntpd off
mv /etc/ntp.conf     /etc/ntp.conf.bak

chkconfig ntpd --list
service ntpd status
```
#时区设置
```bash
#查看是否中国时区
date -R 

#设置中国时区
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
```
### 2.6. 创建所需要目录

```bash
mkdir -p /u01/app/11.2.0/grid
mkdir -p /u01/app/grid
mkdir -p /u01/app/oracle
mkdir -p /u01/app/oracle/product/11.2.0/db_1
mkdir -p /u01/Storage

chown -R grid:oinstall /u01
chown -R oracle:oinstall /u01/app/oracle
chmod -R 775 /u01
```
### 2.7. 其它优化配置：

#修改/etc/security/limits.d/20-nproc.con

```bash
sed -i 's/1024/90000/g' /etc/security/limits.d/90-nproc.conf
```
#修改/etc/security/limits.conf
```bash
cat >> /etc/security/limits.conf <<EOF

*            soft    nofile          65536
*            hard    nofile          65536
*            soft    core            unlimited
*            hard    core            unlimited
*            soft    sigpending      90000
*            hard    sigpending      90000
*            soft    nproc           90000
*            hard    nproc           90000

EOF

```

#修改pam.d/login
```bash
cat >> /etc/pam.d/login <<EOF
#ORACLE SETTING
session required pam_limits.so

EOF

```
#修改/etc/sysctl.conf
```bash
cat >> /etc/sysctl.conf  <<EOF
fs.aio-max-nr = 3145728
fs.file-max = 6815744
#shmax/4096
kernel.shmall = 6710886
#memory*80%
#32G: 32*1024*1024*1024*0.8
kernel.shmmax = 27487790694
kernel.shmmni = 4096
kernel.sem = 6144 50331648 4096 8192
net.ipv4.ip_local_port_range = 9000 65500
net.core.rmem_default = 262144
net.core.rmem_max = 4194304
net.core.wmem_default = 262144
net.core.wmem_max = 4194304
net.ipv4.conf.all.rp_filter=1
net.ipv4.conf.default.rp_filter=1
EOF

```

### 2.8. 配置环境变量

#grid用户，注意oracle1/oracle2两台服务器的区别

```bash
su - grid

cat >> /home/grid/.bash_profile <<'EOF'

export ORACLE_SID=+ASM1
#注意oracle2修改
#export ORACLE_SID=+ASM2
export ORACLE_BASE=/u01/app/grid
export ORACLE_HOME=/u01/app/11.2.0/grid
export NLS_DATE_FORMAT="yyyy-mm-dd HH24:MI:SS"
export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK
export PATH=.:$PATH:$HOME/bin:$ORACLE_HOME/bin
export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib
export CLASSPATH=$ORACLE_HOME/JRE:$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib
EOF

```
#oracle用户，注意oracle1/oracle2的区别
```bash
su - oracle

cat >> /home/oracle/.bash_profile <<'EOF'

export ORACLE_BASE=/u01/app/oracle
export ORACLE_HOME=$ORACLE_BASE/product/11.2.0/db_1
export ORACLE_SID=szhxy1
#注意oracle2修改
#export ORACLE_SID=szhxy2
export PATH=$ORACLE_HOME/bin:$PATH
export LD_LIBRARY_PATH=$ORACLE_HOME/bin:/bin:/usr/bin:/usr/local/bin
export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK
export CLASSPATH=$ORACLE_HOME/JRE:$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib
EOF

```
### 2.9. 配置共享磁盘权限

#### 2.9.1.无多路径模式

#适用于vsphere平台直接共享存储磁盘

#检查磁盘UUID
```bash
sfdisk -s
/sbin/scsi_id --whitelisted --replace-whitespace --device=devicename
```
#显示如下
```
[root@oracle1 ~]# sfdisk -s
/dev/sdb:  10485760
/dev/sdc:  10485760
/dev/sdd:  10485760
/dev/sdf: 524288000
/dev/sdh: 524288000
/dev/sde: 524288000
/dev/sda: 262144000
/dev/sdg: 524288000
/dev/mapper/vg_rac01db01-lv_root: 228073472
/dev/mapper/vg_rac01db01-lv_swap:  33554432
total: 2652381184 blocks

[root@oracle2 ~]# scsi_id --whitelisted --replace-whitespace --device=/dev/sdb
36000c293ce7a60e37e268137c57cef89
[root@oracle2 ~]# scsi_id --whitelisted --replace-whitespace --device=/dev/sdc
36000c29f9c611b02e89db73aa06668fd
[root@oracle2 ~]# scsi_id --whitelisted --replace-whitespace --device=/dev/sdd
36000c2984ad0d3fa2112c64c07a0be74
[root@oracle2 ~]# scsi_id --whitelisted --replace-whitespace --device=/dev/sde
36000c29847a1bd5024998151545bf0e5
[root@oracle2 ~]# scsi_id --whitelisted --replace-whitespace --device=/dev/sdf
36000c297f721308c0d430e00b6fb80df
[root@oracle2 ~]# scsi_id --whitelisted --replace-whitespace --device=/dev/sdg
36000c291c7167764babb12503d0526c7
[root@oracle2 ~]# scsi_id --whitelisted --replace-whitespace --device=/dev/sdh
36000c2950720049c29609f54a0b5008f
```
#99-oracle-asmdevices.rules
```bash
for i in b c d e f g h;
do
echo "KERNEL==\"sd*\", BUS==\"scsi\", PROGRAM==\"/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/\$name\", RESULT==\"`/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/sd$i`\", NAME=\"asm-disk$i\", OWNER=\"grid\", GROUP=\"asmadmin\", MODE=\"0660\"" >> /etc/udev/rules.d/99-oracle-asmdevices.rules
done
```
#检查下文件内容是否正确
```bash
cat /etc/udev/rules.d/99-oracle-asmdevices.rules
```
```
[root@oracle1 ~]# cat /etc/udev/rules.d/99-oracle-asmdevices.rules
KERNEL=="sd*", BUS=="scsi", PROGRAM=="/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/$name", RESULT=="36000c293ce7a60e37e268137c57cef89", NAME="asm-diskb", OWNER="grid", GROUP="asmadmin", MODE="0660"
KERNEL=="sd*", BUS=="scsi", PROGRAM=="/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/$name", RESULT=="36000c29f9c611b02e89db73aa06668fd", NAME="asm-diskc", OWNER="grid", GROUP="asmadmin", MODE="0660"
KERNEL=="sd*", BUS=="scsi", PROGRAM=="/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/$name", RESULT=="36000c2984ad0d3fa2112c64c07a0be74", NAME="asm-diskd", OWNER="grid", GROUP="asmadmin", MODE="0660"
KERNEL=="sd*", BUS=="scsi", PROGRAM=="/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/$name", RESULT=="36000c29847a1bd5024998151545bf0e5", NAME="asm-diske", OWNER="grid", GROUP="asmadmin", MODE="0660"
KERNEL=="sd*", BUS=="scsi", PROGRAM=="/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/$name", RESULT=="36000c297f721308c0d430e00b6fb80df", NAME="asm-diskf", OWNER="grid", GROUP="asmadmin", MODE="0660"
KERNEL=="sd*", BUS=="scsi", PROGRAM=="/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/$name", RESULT=="36000c291c7167764babb12503d0526c7", NAME="asm-diskg", OWNER="grid", GROUP="asmadmin", MODE="0660"
KERNEL=="sd*", BUS=="scsi", PROGRAM=="/sbin/scsi_id --whitelisted --replace-whitespace --device=/dev/$name", RESULT=="36000c2950720049c29609f54a0b5008f", NAME="asm-diskh", OWNER="grid", GROUP="asmadmin", MODE="0660"
```
#启动udev
```bash
/sbin/start_udev
```
#检查asm磁盘
```bash
ll /dev/asm*
```
#显示如下
```
[root@oracle1 ~]# ll /dev/asm*
brw-rw---- 1 grid asmadmin 8,  16 2月  24 14:02 /dev/asm-diskb
brw-rw---- 1 grid asmadmin 8,  32 2月  24 14:02 /dev/asm-diskc
brw-rw---- 1 grid asmadmin 8,  48 2月  24 14:02 /dev/asm-diskd
brw-rw---- 1 grid asmadmin 8,  64 2月  24 14:02 /dev/asm-diske
brw-rw---- 1 grid asmadmin 8,  80 2月  24 14:02 /dev/asm-diskf
brw-rw---- 1 grid asmadmin 8,  96 2月  24 14:02 /dev/asm-diskg
brw-rw---- 1 grid asmadmin 8, 112 2月  24 14:02 /dev/asm-diskh
```

### 2.10. 配置互信

#grid用户
```bash
su - grid

cd /home/grid
mkdir ~/.ssh
chmod 700 ~/.ssh

ssh-keygen -t rsa

#以下只在oracle1执行，逐条执行
cat ~/.ssh/id_rsa.pub >>~/.ssh/authorized_keys

ssh oracle2 cat ~/.ssh/id_rsa.pub >>~/.ssh/authorized_keys

scp ~/.ssh/authorized_keys oracle2:~/.ssh/authorized_keys

ssh oracle1 date;ssh oracle2 date;ssh oracle1-prv date;ssh oracle2-prv date

ssh oracle1 date;ssh oracle2 date;ssh oracle1-prv date;ssh oracle2-prv date

#在oracle2执行
ssh oracle1 date;ssh oracle2 date;ssh oracle1-prv date;ssh oracle2-prv date

ssh oracle1 date;ssh oracle2 date;ssh oracle1-prv date;ssh oracle2-prv date
```
#oracle用户
```bash
su - oracle

cd /home/oracle
mkdir ~/.ssh
chmod 700 ~/.ssh

ssh-keygen -t rsa

ssh-keygen -t dsa

#以下只在oracle1执行，逐条执行
cat ~/.ssh/id_rsa.pub >>~/.ssh/authorized_keys

ssh oracle2 cat ~/.ssh/id_rsa.pub >>~/.ssh/authorized_keys

scp ~/.ssh/authorized_keys oracle2:~/.ssh/authorized_keys

ssh oracle1 date;ssh oracle2 date;ssh oracle1-prv date;ssh oracle2-prv date

ssh oracle1 date;ssh oracle2 date;ssh oracle1-prv date;ssh oracle2-prv date

#在oracle2上执行
ssh oracle1 date;ssh oracle2 date;ssh oracle1-prv date;ssh oracle2-prv date

ssh oracle1 date;ssh oracle2 date;ssh oracle1-prv date;ssh oracle2-prv date
```

### 2.11. 安装vnc

#服务器远程操作，安装vnc，便于图形安装

#安装图形化组件并重启
```bash
yum grouplist
yum groupinstall -y "Server with GUI"

reboot
```
#安装vnc并编辑设置
```bash
yum -y install vnc *vnc-server*

cp /lib/systemd/system/vncserver@.service /etc/systemd/system/vncserver@.service

vi /etc/sysconfig/vncservers
#填入以下内容
VNCSERVERS="1:grid"
VNCSERVERS="2:oracle"
VNCSERVERARGS[1]="-geometry 800x600 -nolisten tcp -localhost -alwaysshared -depth 24"
```
#进入grid测试
```bash
su - grid
vncserver
--->password:vncserver
```
#此时windows打开vnc客户端连接grid用户界面：
```
oracleserverIP:1
```
#进入oracle测试
```bash
su - oracle
vncserver
--->password:vncserver
```
#此时windows打开vnc客户端连接oracle用户界面：
```
oracleserverIP:2
```
#显示如下
```
[root@oracle1 ~]# yum grouplist
Loaded plugins: fastestmirror
There is no installed groups file.
Maybe run: yum groups mark convert (see man yum)
Loading mirror speeds from cached hostfile
 * base: mirrors.neusoft.edu.cn
 * extras: mirrors.neusoft.edu.cn
 * updates: mirrors.neusoft.edu.cn
Available Environment Groups:
   Minimal Install
   Compute Node
   Infrastructure Server
   File and Print Server
   Basic Web Server
   Virtualization Host
   Server with GUI
   GNOME Desktop
   KDE Plasma Workspaces
   Development and Creative Workstation
Available Groups:
   Compatibility Libraries
   Console Internet Tools
   Development Tools
   Graphical Administration Tools
   Legacy UNIX Compatibility
   Scientific Support
   Security Tools
   Smart Card Support
   System Administration Tools
   System Management
Done
[root@oracle1 ~]#

[root@oracle1 ~]# ps -ef|grep vnc
grid      2998     1  0 14:23 pts/0    00:00:00 /bin/Xvnc :1 -auth /home/grid/.Xauthority -desktop oracle1:1 (grid) -fp catalogue:/etc/X11/fontpath.d -geometry 1024x768 -httpd /usr/share/vnc/classes -pn -rfbauth /home/grid/.vnc/passwd -rfbport 5901 -rfbwait 30000
grid      3017     1  0 14:23 pts/0    00:00:00 /bin/sh /home/grid/.vnc/xstartup
root      4508  2099  0 14:26 pts/0    00:00:00 grep --color=auto vnc

```

## 3 开始安装 GI

### 3.1. 上传oracle rac软件安装包并解压缩

#将软件包上传至oracle1的/u01/Storage目录下
```bash
#解压缩
su - root
cd /u01/Storage
#按顺序解压缩
unzip p13390677_112040_Linux-x86-64_1of7.zip

unzip p13390677_112040_Linux-x86-64_2of7.zip

unzip p13390677_112040_Linux-x86-64_3of7.zip

#设置权限
chown -R grid:oinstall /u01/Storage
```
#### 3.2. 安装 cvuqdisk并做安装前检查

#安装cvuqdisk
```bash
#oracle1下执行
su - grid

cd /u01/Storage/grid/rpm
cp cvuqdisk-1.0.9-1.rpm /u01

scp cvuqdisk-1.0.9-1.rpm oracle2:/u01

#oracle1/oracle2都要执行
su - root

cd /u01
rpm -ivh cvuqdisk-1.0.9-1.rpm
```
#安装前检查，只在oracle1上执行
```bash
su - grid

cd /u01/Storage/grid/
./runcluvfy.sh stage -pre crsinst -n oracle1,oracle2 -fixup -verbose|tee -a pre.log
```
#会生成fixup脚本，需在oracle1/oracle2上执行
#如果报错以下，可以忽略
```
Check: Package existence for "pdksh" 
  Node Name     Available                 Required                  Status    
  ------------  ------------------------  ------------------------  ----------
  oracle2       missing                   pdksh-5.2.14              failed    
  oracle1       missing                   pdksh-5.2.14              failed    
Result: Package existence check failed for "pdksh"
```
#如果报错以下内容必须处理
```
Checking Core file name pattern consistency...

ERROR:
PRVF-6402 : Core file name pattern is not same on all the nodes.
Found core filename pattern "|/usr/libexec/abrt-hook-ccpp %s %c %p %u %g %t e %P %I %h" on nodes "oracle1".
Found core filename pattern "core.%p" on nodes "oracle2".
Core file name pattern consistency check failed.
```
#解决办法，可以将node1的abrt-hook-ccpp关闭
#查看core_pattern
```bash
[root@oracle1 ~]# more /proc/sys/kernel/core_pattern
|/usr/libexec/abrt-hook-ccpp %s %c %p %u %g %t e %P %I %h
[root@oracle1 ~]# systemctl status abrt-ccpp.service
● abrt-ccpp.service - Install ABRT coredump hook
   Loaded: loaded (/usr/lib/systemd/system/abrt-ccpp.service; enabled; vendor preset: enabled)
   Active: active (exited) since Wed 2021-11-03 10:58:38 CST; 1 months 18 days ago
  Process: 806 ExecStart=/usr/sbin/abrt-install-ccpp-hook install (code=exited, status=0/SUCCESS)
 Main PID: 806 (code=exited, status=0/SUCCESS)
    Tasks: 0
   CGroup: /system.slice/abrt-ccpp.service
Warning: Journal has been rotated since unit was started. Log output is incomplete or unavailable.


[root@oracle2 ~]# more /proc/sys/kernel/core_pattern
core
[root@oracle2 ~]# systemctl status abrt-ccpp.service
Unit abrt-ccpp.service could not be found.
```
#oracle1关闭abrt-ccpp
```bash
systemctl stop abrt-ccpp.service
systemctl disable abrt-ccpp.service
systemctl status abrt-ccpp.service
```
#此时再次runcluvfy即可通过
```
[root@oracle1 ~]# systemctl stop abrt-ccpp.service
[root@oracle1 ~]# systemctl disable abrt-ccpp.service
Removed symlink /etc/systemd/system/multi-user.target.wants/abrt-ccpp.service.
[root@oracle1 ~]# systemctl status abrt-ccpp.service
● abrt-ccpp.service - Install ABRT coredump hook
   Loaded: loaded (/usr/lib/systemd/system/abrt-ccpp.service; disabled; vendor preset: enabled)
   Active: inactive (dead)

Dec 22 14:06:03 oracle1 systemd[1]: Starting Install ABRT coredump hook...
Dec 22 14:06:03 oracle1 systemd[1]: Started Install ABRT coredump hook.
Dec 22 14:47:32 oracle1 systemd[1]: Stopping Install ABRT coredump hook...
Dec 22 14:47:32 oracle1 systemd[1]: Stopped Install ABRT coredump hook.
[root@oracle1 ~]# more /proc/sys/kernel/core_pattern
core

runcluvfy.sh:
Checking Core file name pattern consistency...
Core file name pattern consistency check passed.
```
#### 3.3. 开始安装GI

#VNC连接grid账户，开始安装

```bash
cd /u01/Storage/grid/
./runInstaller
```
#安装步骤，截图见安装过程截图文档

```
--->skip software updates
--->Install and Configure Oracle Grid Infrastructure for a Cluster
--->Advanced installation
--->English/Simplified Chinese
--->cluster name:rac-scan/scan name:rac-scan/scan port:1521,去掉configure GNS前面的勾
--->add:oracle2/oracle2-vip,SSHconnectivity,test
--->eth1:192.168.202.0:private,eth0:172.17.5.0:public
--->oracle ASM
DiskGroupName:OCR,normal,AUSize:1M,Candidate Disks:sdb/sdc/sdd--->
--->use same passwords for these accounts:Ora543Cle---Do Not Use IPMI
--->asmadmin/asmdba/asmoper
--->Oracle Base:/u01/app/grid,Oracle_Home:/u01/app/11.2.0/grid
--->Inventory Directory:/u01/app/oraInventory
--->缺少pdksh,Device Checks for ASM,ntp报错,都可以忽略
--->install
--->/u01/app/oraInventory/orainstRoot.sh,/u01/app/11.2.0/grid/root.sh，必须先在oracle1上执行完毕这两个脚本，再在oracle2上执行，出现错误时见下面的错误处理步骤，如果弹框看不到内容，可以用鼠标拖动
---->INS-20802，忽略，如果弹框看不到内容，也无法用鼠标拖动，可以按4次Tab键后回车即可
---->INS-32091，忽略，如果弹框看不到内容，也无法用鼠标拖动，可以按4次Tab键后回车即可
---->close
```


#部署过程日志
```
[root@oracle1 ~]# /u01/app/oraInventory/orainstRoot.sh
Changing permissions of /u01/app/oraInventory.
Adding read,write permissions for group.
Removing read,write,execute permissions for world.

Changing groupname of /u01/app/oraInventory to oinstall.
The execution of the script is complete.
[root@oracle1 ~]# /u01/app/11.2.0/grid/root.sh
Performing root user operation for Oracle 11g

The following environment variables are set as:
    ORACLE_OWNER= grid
    ORACLE_HOME=  /u01/app/11.2.0/grid

Enter the full pathname of the local bin directory: [/usr/local/bin]:
   Copying dbhome to /usr/local/bin ...
   Copying oraenv to /usr/local/bin ...
   Copying coraenv to /usr/local/bin ...


Creating /etc/oratab file...
Entries will be added to the /etc/oratab file as needed by
Database Configuration Assistant when a database is created
Finished running generic part of root script.
Now product-specific root actions will be performed.
Using configuration parameter file: /u01/app/11.2.0/grid/crs/install/crsconfig_params
Creating trace directory
User ignored Prerequisites during installation
Installing Trace File Analyzer
OLR initialization - successful
  root wallet
  root wallet cert
  root cert export
  peer wallet
  profile reader wallet
  pa wallet
  peer wallet keys
  pa wallet keys
  peer cert request
  pa cert request
  peer cert
  pa cert
  peer root cert TP
  profile reader root cert TP
  pa root cert TP
  peer pa cert TP
  pa peer cert TP
  profile reader pa cert TP
  profile reader peer cert TP
  peer user cert
  pa user cert
Adding Clusterware entries to upstart
CRS-2672: Attempting to start 'ora.mdnsd' on 'oracle1'
CRS-2676: Start of 'ora.mdnsd' on 'oracle1' succeeded
CRS-2672: Attempting to start 'ora.gpnpd' on 'oracle1'
CRS-2676: Start of 'ora.gpnpd' on 'oracle1' succeeded
CRS-2672: Attempting to start 'ora.cssdmonitor' on 'oracle1'
CRS-2672: Attempting to start 'ora.gipcd' on 'oracle1'
CRS-2676: Start of 'ora.cssdmonitor' on 'oracle1' succeeded
CRS-2676: Start of 'ora.gipcd' on 'oracle1' succeeded
CRS-2672: Attempting to start 'ora.cssd' on 'oracle1'
CRS-2672: Attempting to start 'ora.diskmon' on 'oracle1'
CRS-2676: Start of 'ora.diskmon' on 'oracle1' succeeded
CRS-2676: Start of 'ora.cssd' on 'oracle1' succeeded

已成功创建并启动 ASM。

已成功创建磁盘组OCR。

clscfg: -install mode specified
Successfully accumulated necessary OCR keys.
Creating OCR keys for user 'root', privgrp 'root'..
Operation successful.
CRS-4256: Updating the profile
Successful addition of voting disk 370739098c3e4f4abfecda1e55d7a7ad.
Successful addition of voting disk 01aced74f5474fb3bf8a1ece55c75d9c.
Successful addition of voting disk 70557a6b6e884f8ebfa957b53c4fb8fa.
Successfully replaced voting disk group with +OCR.
CRS-4256: Updating the profile
CRS-4266: Voting file(s) successfully replaced
##  STATE    File Universal Id                File Name Disk group
--  -----    -----------------                --------- ---------
 1. ONLINE   370739098c3e4f4abfecda1e55d7a7ad (/dev/asm-diskb) [OCR]
 2. ONLINE   01aced74f5474fb3bf8a1ece55c75d9c (/dev/asm-diskc) [OCR]
 3. ONLINE   70557a6b6e884f8ebfa957b53c4fb8fa (/dev/asm-diskd) [OCR]
Located 3 voting disk(s).
CRS-2672: Attempting to start 'ora.asm' on 'oracle1'
CRS-2676: Start of 'ora.asm' on 'oracle1' succeeded
CRS-2672: Attempting to start 'ora.OCR.dg' on 'oracle1'
CRS-2676: Start of 'ora.OCR.dg' on 'oracle1' succeeded
Configure Oracle Grid Infrastructure for a Cluster ... succeeded


[root@oracle2 ~]# /u01/app/oraInventory/orainstRoot.sh
Changing permissions of /u01/app/oraInventory.
Adding read,write permissions for group.
Removing read,write,execute permissions for world.

Changing groupname of /u01/app/oraInventory to oinstall.
The execution of the script is complete.
[root@oracle2 ~]# /u01/app/11.2.0/grid/root.sh
Performing root user operation for Oracle 11g

The following environment variables are set as:
    ORACLE_OWNER= grid
    ORACLE_HOME=  /u01/app/11.2.0/grid

Enter the full pathname of the local bin directory: [/usr/local/bin]:
   Copying dbhome to /usr/local/bin ...
   Copying oraenv to /usr/local/bin ...
   Copying coraenv to /usr/local/bin ...

Creating /etc/oratab file...
Entries will be added to the /etc/oratab file as needed by
Database Configuration Assistant when a database is created
Finished running generic part of root script.
Now product-specific root actions will be performed.
Using configuration parameter file: /u01/app/11.2.0/grid/crs/install/crsconfig_params
Creating trace directory
User ignored Prerequisites during installation
Installing Trace File Analyzer
OLR initialization - successful
Adding Clusterware entries to upstart
CRS-4402: The CSS daemon was started in exclusive mode but found an active CSS daemon on node oracle1, number 1, and is terminating
An active cluster was found during exclusive startup, restarting to join the cluster
Configure Oracle Grid Infrastructure for a Cluster ... succeeded
```

### 3.5. 查看状态

```bash
crsctl status resource -t
```
```
[root@oracle2 ~]# crsctl status resource -t
--------------------------------------------------------------------------------
NAME           TARGET  STATE        SERVER                   STATE_DETAILS
--------------------------------------------------------------------------------
Local Resources
--------------------------------------------------------------------------------
ora.ORC.dg
               ONLINE  ONLINE       oracle1
               ONLINE  ONLINE       oracle2
ora.asm
               ONLINE  ONLINE       oracle1                  Started
               ONLINE  ONLINE       oracle2                  Started
ora.gsd
               OFFLINE OFFLINE      oracle1
               OFFLINE OFFLINE      oracle2
ora.net1.network
               ONLINE  ONLINE       oracle1
               ONLINE  ONLINE       oracle2
ora.ons
               ONLINE  ONLINE       oracle1
               ONLINE  ONLINE       oracle2
--------------------------------------------------------------------------------
Cluster Resources
--------------------------------------------------------------------------------
ora.LISTENER_SCAN1.lsnr
      1        ONLINE  ONLINE       oracle1
ora.cvu
      1        ONLINE  ONLINE       oracle1
ora.oc4j
      1        ONLINE  ONLINE       oracle1
ora.oracle1.vip
      1        ONLINE  ONLINE       oracle1
ora.oracle2.vip
      1        ONLINE  ONLINE       oracle2
ora.scan1.vip
      1        ONLINE  ONLINE       oracle1

```
## 4 创建ASM磁盘组：DATA/FRA

#grid用户图形界面下
```bash
asmca
```
```
 --->create
 --->DATA,external,sde,OK，如果弹框看不到磁盘选择项，可以用鼠标拖动
 --->creat
 --->FRA,external,sdf,OK，如果弹框看不到磁盘选择项，可以用鼠标拖动
 --->exit
```
#验证
```
[grid@oracle1 ~]$ asmcmd
ASMCMD> lsdg
State    Type    Rebal  Sector  Block       AU  Total_MB  Free_MB  Req_mir_free_MB  Usable_file_MB  Offline_disks  Voting_files  Name
MOUNTED  EXTERN  N         512   4096  1048576    512000   511901                0          511901              0             N  DATA/
MOUNTED  EXTERN  N         512   4096  1048576    307200   307103                0          307103              0             N  FRA/
MOUNTED  NORMAL  N         512   4096  1048576     61440    60514            20480           20017              0             Y  ORC/
ASMCMD> lsdsk
Path
/dev/sdb
/dev/sdc
/dev/sdd
/dev/sde
/dev/sdf
ASMCMD>
[grid@oracle1 ~]# crsctl status resource -t
--------------------------------------------------------------------------------
NAME           TARGET  STATE        SERVER                   STATE_DETAILS
--------------------------------------------------------------------------------
Local Resources
--------------------------------------------------------------------------------
ora.DATA.dg
               ONLINE  ONLINE       oracle1
               ONLINE  ONLINE       oracle2
ora.FRA.dg
               ONLINE  ONLINE       oracle1
               ONLINE  ONLINE       oracle2
ora.LISTENER.lsnr
               ONLINE  ONLINE       oracle1
               ONLINE  ONLINE       oracle2
ora.ORC.dg
               ONLINE  ONLINE       oracle1
               ONLINE  ONLINE       oracle2
ora.asm
               ONLINE  ONLINE       oracle1                  Started
               ONLINE  ONLINE       oracle2                  Started
ora.gsd
               OFFLINE OFFLINE      oracle1
               OFFLINE OFFLINE      oracle2
ora.net1.network
               ONLINE  ONLINE       oracle1
               ONLINE  ONLINE       oracle2
ora.ons
               ONLINE  ONLINE       oracle1
               ONLINE  ONLINE       oracle2
--------------------------------------------------------------------------------
Cluster Resources
--------------------------------------------------------------------------------
ora.LISTENER_SCAN1.lsnr
      1        ONLINE  ONLINE       oracle1
ora.cvu
      1        ONLINE  ONLINE       oracle1
ora.oc4j
      1        ONLINE  ONLINE       oracle1
ora.oracle1.vip
      1        ONLINE  ONLINE       oracle1
ora.oracle2.vip
      1        ONLINE  ONLINE       oracle2
ora.scan1.vip
      1        ONLINE  ONLINE       oracle1
[root@oracle1 ~]#

```
## 5 安装oracle软件

#将目录/u01/Storage/database赋权给oracle
```bash
su - root

chown -R oracle:oinstall /u01/Storage/database
```
#安装前检查
```bash
su - grid

cd /u01/Storage/grid
  ./runcluvfy.sh stage -pre dbinst -n oracle1,oracle2 -fixup -verbose 
```
#如果下面报错内容，可以忽略
```
Check: Package existence for "pdksh"
  Node Name     Available                 Required                  Status
  ------------  ------------------------  ------------------------  ----------
  oracle2       missing                   pdksh-5.2.14              failed
  oracle1       missing                   pdksh-5.2.14              failed
Result: Package existence check failed for "pdksh"


ERROR:
PRVG-1101 : SCAN name "rac-scan" failed to resolve
  SCAN Name     IP Address                Status                    Comment
  ------------  ------------------------  ------------------------  ----------
  rac-scan      172.17.5.105              failed                    NIS Entry

ERROR:
PRVF-4657 : Name resolution setup check for "rac-scan" (IP address: 172.17.5.105) failed

ERROR:
PRVF-4664 : Found inconsistent name resolution entries for SCAN name "rac-scan"

Verification of SCAN VIP and Listener setup failed

```
#通过vnc以 Oracle 用户登录图形化界面安装 Oracle 数据库软件
```
#根据前面vnc的配置，连接地址
oracle1IP:2
```
#开始安装
```bash
cd /u01/Storage/database
./runInstaller
```
#安装过程
```
--->去掉I wish前面的打勾
    --->弹框：Yes
--->Skip software updates
--->Install database software only
--->Orace Real Application Clusters database installation
    --->Select All
    --->SSH Connectivity
    --->Test
--->English/Simplified Chinese
--->Enterprise Edition
--->Oracle Base: /u01/app/oracle
    --->Software Location: /u01/app/oracle/product/11.2.0/db_1
--->dba/oper
--->pdksh/scan: Ignore All
--->Install
--->/u01/app/oracle/product/11.2.0/db_1/root.sh，分别在oracle1/oracle2上用root账户运行，如果弹框看不到内容，可以用鼠标拖动
--->Close
```
#执行 root 脚本日志
```
[root@oracle1 Storage]# /u01/app/oracle/product/11.2.0/db_1/root.sh
Performing root user operation for Oracle 11g

The following environment variables are set as:
    ORACLE_OWNER= oracle
    ORACLE_HOME=  /u01/app/oracle/product/11.2.0/db_1

Enter the full pathname of the local bin directory: [/usr/local/bin]:
The contents of "dbhome" have not changed. No need to overwrite.
The contents of "oraenv" have not changed. No need to overwrite.
The contents of "coraenv" have not changed. No need to overwrite.

Entries will be added to the /etc/oratab file as needed by
Database Configuration Assistant when a database is created
Finished running generic part of root script.
Now product-specific root actions will be performed.
Finished product-specific root actions.

[root@oracle2 ~]# /u01/app/oracle/product/11.2.0/db_1/root.sh
Performing root user operation for Oracle 11g

The following environment variables are set as:
    ORACLE_OWNER= oracle
    ORACLE_HOME=  /u01/app/oracle/product/11.2.0/db_1

Enter the full pathname of the local bin directory: [/usr/local/bin]:
The contents of "dbhome" have not changed. No need to overwrite.
The contents of "oraenv" have not changed. No need to overwrite.
The contents of "coraenv" have not changed. No need to overwrite.

Entries will be added to the /etc/oratab file as needed by
Database Configuration Assistant when a database is created
Finished running generic part of root script.
Now product-specific root actions will be performed.
Finished product-specific root actions.
```
## 6 建立数据库实例

#通过vnc以 Oracle 用户登录图形化界面安装 

#执行建库 dbca
```bash
dbca
```
#安装过程，截图见另一份截图文档
```
--->Oracle RAC database
--->Create a Database
--->General Purpose
--->Admin-Managed/szhxy/szhxy/Select All
--->Configure Enterprise Manager
--->SYS/SYSTEM/DBSNMP/SYSMAN使用一个密码: XXXXXX
--->ASM/+DATA
    --->弹框中输入ASMSNMP的密码(此弹框可能需要鼠标拖开，密码为GI时设置的密码)
--->Specify FRA: +FRA/300000M(大小根据实际情况填写)/Enable Arechiving
--->Sample Schemas，可以去掉打勾
--->Memory: Custom---SGA:6000M/PGA:2000M(大小根据实际设置memory*60%左右)
    --->Sizing: Processes---3000(根据服务器资源调整)
    --->CharacterSets: ZHS16GBK/AL16UTF16/American/United States
    --->Connection Mode: Dedicated Server Mode
--->Next
--->Finish
--->OK，此处弹框可能需要鼠标拖开
--->等待执行完毕，点击Exit
```

## 7 检查修改部分数据库配置参数

### 7.1.密码过期时间

```bash
su - oracle
sqlplus / as sysdba
```
```oracle
select resource_name,limit from dba_profiles where profile='DEFAULT';

alter profile default limit password_life_time unlimited;
```
#日志
```
SQL> select resource_name,limit from dba_profiles where profile='DEFAULT';

RESOURCE_NAME                    LIMIT
-------------------------------- ----------------------------------------
COMPOSITE_LIMIT                  UNLIMITED
SESSIONS_PER_USER                UNLIMITED
CPU_PER_SESSION                  UNLIMITED
CPU_PER_CALL                     UNLIMITED
LOGICAL_READS_PER_SESSION        UNLIMITED
LOGICAL_READS_PER_CALL           UNLIMITED
IDLE_TIME                        UNLIMITED
CONNECT_TIME                     UNLIMITED
PRIVATE_SGA                      UNLIMITED
FAILED_LOGIN_ATTEMPTS            10
PASSWORD_LIFE_TIME               180
PASSWORD_REUSE_TIME              UNLIMITED
PASSWORD_REUSE_MAX               UNLIMITED
PASSWORD_VERIFY_FUNCTION         NULL
PASSWORD_LOCK_TIME               1
PASSWORD_GRACE_TIME              7

16 rows selected.

SQL>

SQL> alter profile default limit password_life_time unlimited;

Profile altered.

SQL> select resource_name,limit from dba_profiles where profile='DEFAULT';

RESOURCE_NAME                    LIMIT
-------------------------------- ----------------------------------------
COMPOSITE_LIMIT                  UNLIMITED
SESSIONS_PER_USER                UNLIMITED
CPU_PER_SESSION                  UNLIMITED
CPU_PER_CALL                     UNLIMITED
LOGICAL_READS_PER_SESSION        UNLIMITED
LOGICAL_READS_PER_CALL           UNLIMITED
IDLE_TIME                        UNLIMITED
CONNECT_TIME                     UNLIMITED
PRIVATE_SGA                      UNLIMITED
FAILED_LOGIN_ATTEMPTS            10
PASSWORD_LIFE_TIME               UNLIMITED

RESOURCE_NAME                    LIMIT
-------------------------------- ----------------------------------------
PASSWORD_REUSE_TIME              UNLIMITED
PASSWORD_REUSE_MAX               UNLIMITED
PASSWORD_VERIFY_FUNCTION         NULL
PASSWORD_LOCK_TIME               1
PASSWORD_GRACE_TIME              7

16 rows selected.

```
### 7.2.归档、redo、undo、datafile等检查

```oracle
archive log list;
show parameter recovery;
select * from v$recovery_area_usage;

select group#,thread#,sequence#,bytes/1024/1024 MB,members,archived,status from v$log;

select group#,type,member from v$logfile order by 1;

show parameter undo;

select tablespace_name, file_name,bytes/1024/1024 MB from dba_data_files order by 1;
```
#日志
```
SQL> archive log list;
Database log mode              Archive Mode
Automatic archival             Enabled
Archive destination            USE_DB_RECOVERY_FILE_DEST
Oldest online log sequence     7
Next log sequence to archive   8
Current log sequence           8
SQL> show parameter recovery;

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_recovery_file_dest                string      +FRA
db_recovery_file_dest_size           big integer 500000M
recovery_parallelism                 integer     0
SQL> select group#,thread#,sequence#,bytes/1024/1024 MB,members,archived,status from v$log;

    GROUP#    THREAD#  SEQUENCE#         MB    MEMBERS ARC STATUS
---------- ---------- ---------- ---------- ---------- --- ----------------
         1          1          7         50          2 YES INACTIVE
         2          1          8         50          2 NO  CURRENT
         3          2          3         50          2 NO  CURRENT
         4          2          2         50          2 YES INACTIVE

SQL> select group#,type,member from v$logfile order by 1;

       GROUP# TYPE    MEMBER
---------- ------- -----------------------------------------------------

         1 ONLINE  +FRA/szhxy/onlinelog/group_1.257.1097586371
         1 ONLINE  +DATA/szhxy/onlinelog/group_1.261.1097586371
         2 ONLINE  +FRA/szhxy/onlinelog/group_2.258.1097586371
         2 ONLINE  +DATA/szhxy/onlinelog/group_2.262.1097586371
         3 ONLINE  +DATA/szhxy/onlinelog/group_3.265.1097586491
         3 ONLINE  +FRA/szhxy/onlinelog/group_3.259.1097586491
         4 ONLINE  +DATA/szhxy/onlinelog/group_4.266.1097586491
         4 ONLINE  +FRA/szhxy/onlinelog/group_4.260.1097586491


8 rows selected.

SQL> show parameter undo;

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
undo_management                      string      AUTO
undo_retention                       integer     900
undo_tablespace                      string      UNDOTBS1
SQL> select tablespace_name, file_name,bytes/1024/1024 MB from dba_data_files order by 1;

TABLESPACE_NAME                FILE_NAME                                                  MB
------------------------------ -------------------------------------------------- ----------
SYSAUX                         +DATA/szhxy/datafile/sysaux.257.1097586295                540
SYSTEM                         +DATA/szhxy/datafile/system.256.1097586295                740
UNDOTBS1                       +DATA/szhxy/datafile/undotbs1.258.1097586295               95
UNDOTBS2                       +DATA/szhxy/datafile/undotbs2.264.1097586427               25
USERS                          +DATA/szhxy/datafile/users.259.1097586295                   5
```
### 7.3.查看集群状态

#oracle1服务器执行
#root账户下
```bash
. oraenv
--->+ASM1
#集群状态
crsctl status resource -t
#设置集群自动启动
crsctl enable crs
#asm
srvctl status asm

vi /etc/oratab
#全部修改为Y
+ASM1:/u01/app/11.2.0/grid:Y            # line added by Agent
szhxy:/u01/app/oracle/product/11.2.0/db_1:Y        # line added by Agent

```
#切换至grid用户
```
su - gird
asmcmd
lsdg
#数据库
srvctl status database -d xydb
#监听
lsnrctl status
#外部连接数据库
sqlplus test/test@scanIP:1521/xydb
#比如
sqlplus test/test@172.17.5.105:1521/xydb
```
#日志
```
[root@oracle1 ~]# su - grid
Last login: Wed Dec 22 18:49:00 CST 2021 on pts/1
[grid@oracle1 ~]$ crsctl status resource -t

--------------------------------------------------------------------------------
NAME           TARGET  STATE        SERVER                   STATE_DETAILS
--------------------------------------------------------------------------------
Local Resources
--------------------------------------------------------------------------------
ora.DATA.dg
               ONLINE  ONLINE       oracle1
               ONLINE  ONLINE       oracle2
ora.FRA.dg
               ONLINE  ONLINE       oracle1
               ONLINE  ONLINE       oracle2
ora.LISTENER.lsnr
               ONLINE  ONLINE       oracle1
               ONLINE  ONLINE       oracle2
ora.OCR.dg
               ONLINE  ONLINE       oracle1
               ONLINE  ONLINE       oracle2
ora.asm
               ONLINE  ONLINE       oracle1                  Started
               ONLINE  ONLINE       oracle2                  Started
ora.gsd
               OFFLINE OFFLINE      oracle1
               OFFLINE OFFLINE      oracle2
ora.net1.network
               ONLINE  ONLINE       oracle1
               ONLINE  ONLINE       oracle2
ora.ons
               ONLINE  ONLINE       oracle1
               ONLINE  ONLINE       oracle2
--------------------------------------------------------------------------------
Cluster Resources
--------------------------------------------------------------------------------
ora.LISTENER_SCAN1.lsnr
      1        ONLINE  ONLINE       oracle1
ora.cvu
      1        ONLINE  ONLINE       oracle1
ora.oc4j
      1        ONLINE  ONLINE       oracle1
ora.oracle1.vip
      1        ONLINE  ONLINE       oracle1
ora.oracle2.vip
      1        ONLINE  ONLINE       oracle2
ora.scan1.vip
      1        ONLINE  ONLINE       oracle1
ora.szhxy.db
      1        ONLINE  ONLINE       oracle1                  Open
      2        ONLINE  ONLINE       oracle2                  Open
      
[grid@oracle1 ~]$ srvctl status asm
ASM is running on oracle1,oracle2

[grid@oracle1 ~]$ asmcmd
ASMCMD> lsdg
State    Type    Rebal  Sector  Block       AU  Total_MB  Free_MB  Req_mir_free_MB  Usable_file_MB  Offline_disks  Voting_files  Name
MOUNTED  EXTERN  N         512   4096  1048576   1536000  1534208                0         1534208              0             N  DATA/
MOUNTED  EXTERN  N         512   4096  1048576    512000   511604                0          511604              0             N  FRA/
MOUNTED  NORMAL  N         512   4096  1048576     30720    29794            10240            9777              0             Y  OCR/
ASMCMD>

[grid@oracle1 ~]$  srvctl status database -d szhxy
实例 szhxy1 正在节点 oracle1 上运行
实例 szhxy2 正在节点 oracle2 上运行

[grid@oracle1 ~]$ lsnrctl status


LSNRCTL for Linux: Version 11.2.0.4.0 - Production on 25-FEB-2022 14:08:24

Copyright (c) 1991, 2013, Oracle.  All rights reserved.

Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=LISTENER)))
STATUS of the LISTENER
------------------------
Alias                     LISTENER
Version                   TNSLSNR for Linux: Version 11.2.0.4.0 - Production
Start Date                25-FEB-2022 11:12:43
Uptime                    0 days 2 hr. 55 min. 41 sec
Trace Level               off
Security                  ON: Local OS Authentication
SNMP                      OFF
Listener Parameter File   /u01/app/11.2.0/grid/network/admin/listener.ora
Listener Log File         /u01/app/grid/diag/tnslsnr/oracle1/listener/alert/log.xml
Listening Endpoints Summary...
  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=LISTENER)))
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=172.17.5.101)(PORT=1521)))
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=172.17.5.103)(PORT=1521)))
Services Summary...
Service "+ASM" has 1 instance(s).
  Instance "+ASM1", status READY, has 1 handler(s) for this service...
Service "szhxy" has 1 instance(s).
  Instance "szhxy1", status READY, has 1 handler(s) for this service...
Service "szhxyXDB" has 1 instance(s).
  Instance "szhxy1", status READY, has 1 handler(s) for this service...
The command completed successfully
```

### 7.4.创建表空间、用户、表等测试

```oracle
create tablespace test datafile '+DATA' size 1G autoextend on next 1G maxsize 31G;
alter tablespace test add datafile '+DATA' size 1G autoextend on next 1G maxsize 31G;

create user test identified by test default tablespace test;
grant connect,resource to test;

conn test/test

create table test1(id number,name varchar2(20));
insert into test1 values(1,'JACKY');
commit;
select * from test1;

```
#日志
```
SQL> create tablespace test datafile '+DATA' size 1G autoextend on next 1G maxsize 31G;

Tablespace created.

SQL> create user test identified by test default tablespace test;

User created.
SQL> grant connect,resource to test;

Grant succeeded.

SQL> conn test/test;
Connected.
SQL> create table test1(id number,name varchar2(20));

Table created.

SQL> insert into test1 values(1,'JACKY');

1 row created.

SQL> commit;

Commit complete.

SQL> select * from test1;

        ID NAME
---------- --------------------
         1 JACKY

SQL>

```
## 8 备份

### 8.1.rman备份

#根据磁盘的实际大小，建立备份目录
```bash
su - oracle

mkdir /home/oracle/backup
touch /home/oracle/backup/rmanrun.log
touch /home/oracle/backup/rmanbak.sh
chmod a+x /home/oracle/backup/rmanbak.sh
```

#rman全库备份脚本
```bash
vi /home/oracle/backup/rmanbak.sh
```
#填入以下内容
```
#!/bin/bash

time=$(date +"%Y%m%d")
rman_dir=/home/oracle/backup

if [ -f $HOME/.bash_profile ]; then
    . $HOME/.bash_profile
elif [ -f $HOME/.profile ]; then
        . $HOME/.profile
fi

echo `date` > $rman_dir/rmanrun.log

rman target / log=$rman_dir/rmanfullbak_$time.log append <<EOF
run{
   CONFIGURE CONTROLFILE AUTOBACKUP ON;
   CONFIGURE BACKUP OPTIMIZATION ON;
   allocate channel c1 type disk;
   allocate channel c2 type disk;
   allocate channel c3 type disk;
   allocate channel c4 type disk;
   sql 'alter system archive log current';
   backup as compressed backupset database plus archivelog delete all input;
   sql 'alter system archive log current';
   backup archivelog all;
   crosscheck backup;
   delete noprompt obsolete;
   delete noprompt expired backup;
   release channel c1;
   release channel c2;
   release channel c3;
   release channel c4;
}
exit;
EOF
 >> $rman_dir/rmanrun.log
#delete 7days before log
find $rman_dir -name 'rmanfullbak_*.log' -mtime +7 -exec rm {} \;
echo `date ` >> $rman_dir/rmanrun.log
```

#设置调度任务
```bash
crontab -e

#每天0:30开始执行
30 0 * * * /home/oracle/backup/rmanbak.sh
```

### 8.2.expdp备份

#设置备份目录
```bash
su - oracle

mkdir /home/oracle/expdir
touch /home/oracle/expdir/expdir.sh
chmod a+x /home/oracle/expdir/expdir.sh
```
#oracle配置
```bash
sqlplus  / as sysdba
```
#创建目录
```
create directory expdir as '/home/oracle/expdir';
grant read,write on directory expdir to public;
```
#expdp脚本

#全库导出
```bash
expdp system/xxxx directory=expdir dumpfile=20211224.dmp logfile=20211224.log full=y parallel=4 cluster=N
```
#导出部分用户
```bash
expdp system/xxxx directory=expdir dumpfile=20211224.dmp logfile=20211224.log schemas=test,test1,test2 parallel=4 cluster=N
```

#定时备份脚本
#设置导出目录
```bash
su - oracle
mkdir -p /home/oracle/expdir
touch /home/oracle/expdir/expdir.sh
chmod a+x /home/oracle/expdir/expdir.sh
```

#脚本
```
#!/bin/bash

time=$(date +"%Y%m%d")
expdp_dir=/home/oracle/expdir

if [ -f $HOME/.bash_profile ]; then
    . $HOME/.bash_profile
elif [ -f $HOME/.profile ]; then
        . $HOME/.profile
fi

dmpfile=full_db$time.dmp
logfile=full_db$time.log

echo start expdp $dmpfile ... >> $expdp_dir/expdprun.log

expdp system/Z4wKxUTEb77 directory=expdir dumpfile=20211224.dmp logfile=$logfile full=y  parallel=4 cluster=N

echo done expdp $dmpfile ...  >> $expdp_dir/expdprun.log

#delete 3days before log 

echo start delete $logfile ... >> $expdp_dir/expdprun.log
find $expdp_dir -name 'full_db_*.log' -mtime +3 -exec rm {} \;

echo start delete $dmpfile ... >> $expdp_dir/expdprun.log
find $expdp_dir -name 'full_db_*.dmp' -mtime +3 -exec rm {} \;

echo done delete ...  >> $expdp_dir/expdprun.log
```
#设置调度任务
```bash
crontab -e

#每天0:30开始执行
30 1 * * * /home/oracle/expdir/expdir.sh
```